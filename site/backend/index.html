
<!doctype html>
<html lang="de" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Lehrmaterial, Übungen, Aufgaben und Hilfen für Aktuelle Trends der IKT">
      
      
      
        <meta name="author" content="Jörn Freiheit">
      
      
        <link rel="canonical" href="http://freiheit.f4.htw-berlin.de/ikt/backend/">
      
      <link rel="icon" href="../img/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.6">
    
    
      
        <title>Backend - Progressive Web Apps</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.802231af.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#757575">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="grey" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#backend-rest-server" class="md-skip">
          Zum Inhalt
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Progressive Web Apps" class="md-header__button md-logo" aria-label="Progressive Web Apps" data-md-component="logo">
      
  <img src="../img/fiw.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Progressive Web Apps
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Backend
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Suche" placeholder="Suche" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Suche">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Zurücksetzen" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Suche wird initialisiert
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/jfreiheit/ikt_2022/" title="Quellcode" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    webtech
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Progressive Web Apps" class="md-nav__button md-logo" aria-label="Progressive Web Apps" data-md-component="logo">
      
  <img src="../img/fiw.jpg" alt="logo">

    </a>
    Progressive Web Apps
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/jfreiheit/ikt_2022/" title="Quellcode" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    webtech
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../einfuehrung/" class="md-nav__link">
        Einführung
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../grundgeruest/" class="md-nav__link">
        Grundgerüst
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../manifest/" class="md-nav__link">
        Manifest
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../serviceworker/" class="md-nav__link">
        Service worker
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../promises/" class="md-nav__link">
        Promises & Fetch
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../caching/" class="md-nav__link">
        Caching
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Backend
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Backend
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Inhaltsverzeichnis">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Inhaltsverzeichnis
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ein-nodejs-projekt-mit-express" class="md-nav__link">
    Ein Node.js-Projekt mit Express
  </a>
  
    <nav class="md-nav" aria-label="Ein Node.js-Projekt mit Express">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#serverjs-erstellen-und-implementieren" class="md-nav__link">
    server.js erstellen und implementieren
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#router" class="md-nav__link">
    Router
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#starten-des-projektes-und-installation-von-nodemon" class="md-nav__link">
    Starten des Projektes und Installation von nodemon
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongoose-installieren" class="md-nav__link">
    Mongoose installieren
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb-compass" class="md-nav__link">
    MongoDB Compass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dotenv-fur-sichere-zugangsdaten" class="md-nav__link">
    Dotenv für sichere Zugangsdaten
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ein-model-erstellen" class="md-nav__link">
    Ein Model erstellen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zugriffe-auf-die-datenbank" class="md-nav__link">
    Zugriffe auf die Datenbank
  </a>
  
    <nav class="md-nav" aria-label="Zugriffe auf die Datenbank">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-read-all" class="md-nav__link">
    R - read all
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-create" class="md-nav__link">
    C - create
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#r-read-one" class="md-nav__link">
    R - read one
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#u-update" class="md-nav__link">
    U - update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d-delete-one" class="md-nav__link">
    D - delete one
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-origin-resource-sharing-cors" class="md-nav__link">
    Cross-Origin Resource Sharing (CORS)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#erweiterung-um-das-speichern-von-bildern" class="md-nav__link">
    Erweiterung um das Speichern von Bildern
  </a>
  
    <nav class="md-nav" aria-label="Erweiterung um das Speichern von Bildern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#upload-von-bildern" class="md-nav__link">
    Upload von Bildern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routen-andern-und-einbinden" class="md-nav__link">
    Routen ändern und einbinden
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-mithilfe-von-postman" class="md-nav__link">
    Upload mithilfe von Postman
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-von-bildern" class="md-nav__link">
    Download von Bildern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-mithilfe-von-postman" class="md-nav__link">
    Download mithilfe von Postman
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-als-base64-string" class="md-nav__link">
    Download als base64-String
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-von-bildern" class="md-nav__link">
    Delete von Bildern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-mithilfe-von-postman" class="md-nav__link">
    Delete mithilfe von Postman
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zusammenfuhren-der-funktionalitaten" class="md-nav__link">
    Zusammenführen der Funktionalitäten
  </a>
  
    <nav class="md-nav" aria-label="Zusammenführen der Funktionalitäten">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zum-verstandnis" class="md-nav__link">
    Zum Verständnis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-kompletter-datensatz" class="md-nav__link">
    POST - kompletter Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-ein-kompletter-datensatz" class="md-nav__link">
    GET - ein kompletter Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-alle-datensatze" class="md-nav__link">
    GET - alle Datensätze
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-einen-datensatz" class="md-nav__link">
    DELETE - einen Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zusammenfassung-code-des-backends" class="md-nav__link">
    Zusammenfassung - Code des Backends
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zusammenfassung-die-mongodb-posts" class="md-nav__link">
    Zusammenfassung - die MongoDB posts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../indexeddb/" class="md-nav__link">
        IndexedDB
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../kamera/" class="md-nav__link">
        Kamera
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../geolocation/" class="md-nav__link">
        Geolocation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../backgroundsync/" class="md-nav__link">
        Hintergrundsynchronisation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../pushnotes/" class="md-nav__link">
        Push Notifications
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tools/" class="md-nav__link">
        Tools
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Inhaltsverzeichnis">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Inhaltsverzeichnis
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ein-nodejs-projekt-mit-express" class="md-nav__link">
    Ein Node.js-Projekt mit Express
  </a>
  
    <nav class="md-nav" aria-label="Ein Node.js-Projekt mit Express">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#serverjs-erstellen-und-implementieren" class="md-nav__link">
    server.js erstellen und implementieren
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#router" class="md-nav__link">
    Router
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#starten-des-projektes-und-installation-von-nodemon" class="md-nav__link">
    Starten des Projektes und Installation von nodemon
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongoose-installieren" class="md-nav__link">
    Mongoose installieren
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb-compass" class="md-nav__link">
    MongoDB Compass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dotenv-fur-sichere-zugangsdaten" class="md-nav__link">
    Dotenv für sichere Zugangsdaten
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ein-model-erstellen" class="md-nav__link">
    Ein Model erstellen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zugriffe-auf-die-datenbank" class="md-nav__link">
    Zugriffe auf die Datenbank
  </a>
  
    <nav class="md-nav" aria-label="Zugriffe auf die Datenbank">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-read-all" class="md-nav__link">
    R - read all
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-create" class="md-nav__link">
    C - create
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#r-read-one" class="md-nav__link">
    R - read one
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#u-update" class="md-nav__link">
    U - update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d-delete-one" class="md-nav__link">
    D - delete one
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-origin-resource-sharing-cors" class="md-nav__link">
    Cross-Origin Resource Sharing (CORS)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#erweiterung-um-das-speichern-von-bildern" class="md-nav__link">
    Erweiterung um das Speichern von Bildern
  </a>
  
    <nav class="md-nav" aria-label="Erweiterung um das Speichern von Bildern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#upload-von-bildern" class="md-nav__link">
    Upload von Bildern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routen-andern-und-einbinden" class="md-nav__link">
    Routen ändern und einbinden
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-mithilfe-von-postman" class="md-nav__link">
    Upload mithilfe von Postman
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-von-bildern" class="md-nav__link">
    Download von Bildern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-mithilfe-von-postman" class="md-nav__link">
    Download mithilfe von Postman
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-als-base64-string" class="md-nav__link">
    Download als base64-String
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-von-bildern" class="md-nav__link">
    Delete von Bildern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-mithilfe-von-postman" class="md-nav__link">
    Delete mithilfe von Postman
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zusammenfuhren-der-funktionalitaten" class="md-nav__link">
    Zusammenführen der Funktionalitäten
  </a>
  
    <nav class="md-nav" aria-label="Zusammenführen der Funktionalitäten">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zum-verstandnis" class="md-nav__link">
    Zum Verständnis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-kompletter-datensatz" class="md-nav__link">
    POST - kompletter Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-ein-kompletter-datensatz" class="md-nav__link">
    GET - ein kompletter Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-alle-datensatze" class="md-nav__link">
    GET - alle Datensätze
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-einen-datensatz" class="md-nav__link">
    DELETE - einen Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zusammenfassung-code-des-backends" class="md-nav__link">
    Zusammenfassung - Code des Backends
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zusammenfassung-die-mongodb-posts" class="md-nav__link">
    Zusammenfassung - die MongoDB posts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jfreiheit/ikt_2022/edit/master/docs/backend.md" title="Seite editieren" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="backend-rest-server">Backend - REST-Server<a class="headerlink" href="#backend-rest-server" title="Permanent link">&para;</a></h1>
<p>Ehe wir uns der <a href="https://developer.mozilla.org/de/docs/Web/API/IndexedDB_API">IndexedDB-API</a> zuwenden, erstellen wir zunächst eine "richtige" Datenbank für unsere Posts. Für diese Datenbank stellen wir die Implementierung einer Schnittstelle bereit, so dass wir die wesentlichen Datenbankanfragen darüber ausführen können. Diese wesentlichen Datenbankfragen werden mit <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> abgekürzt, für <strong>C</strong>reate, <strong>R</strong>ead, <strong>U</strong>pdate und <strong>D</strong>elete. Das bedeutet, wir implementieren Funktionalitäten, mit denen wir einen neuen <code>post</code> in die Datenbank einfügen (<em>create</em>), aus der Datenbank auslesen (<em>read</em>), in der Datenbank aktualisieren (<em>update</em>) und aus der Datenbank löschen (<em>delete</em>) können. </p>
<p>Die Schnittstelle, die wir implementieren, ist eine sogenannte <a href="https://www.redhat.com/de/topics/api/what-is-a-rest-api">REST-API</a>. <em>REST</em> steht für <a href="https://de.wikipedia.org/wiki/Representational_State_Transfer"><em>Representational State Transfer</em></a> und basiert auf einigen wenigen Prinzipien:</p>
<ol>
<li>Alles wird als eine <em>Ressource</em> betrachtet, z.B. <code>post</code>.</li>
<li>Jede Ressource ist durch <em>URIs</em> (<em>Uniform Resource Identifiers</em>) eindeutig identifizierbar, z.B. <code>http://localhost/posts</code>.</li>
<li>Es werden die <a href="https://de.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP-Anfragemethoden">Standard-HTTP-Methoden</a> verwendet, also <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>UPDATE</code>.  </li>
<li>Ressourcen können in verschiedenen Formaten vorliegen, z.B. in <a href="https://html.spec.whatwg.org/multipage/">HTML</a>, <a href="https://www.w3.org/TR/xml/">XML</a>, <a href="https://jsonapi.org/format/">JSON</a>, ...</li>
<li>Die Kommunikation ist <em>zustandslos</em>. Jede einzelne HTTP-Anfrage wird komplett isoliert bearbeitet. Es gibt keinerlei Anfragehistorie. </li>
</ol>
<p>Das bedeutet, wir erstellen ein Backend (einen REST-Server), an den HTTP-Anfragen mit der eindeutig identifizierbaren Ressource gestellt werden. Das Backend erstellt daraus die entsprechende SQL-Query. Das Resultat der Datenbankanfrage wird im <code>JSON</code>- oder <code>HTML</code>- oder <code>XML</code>- oder in einem anderen Format bereitsgestellt.</p>
<p><img alt="restapi" src="../files/61_restapi.png" /></p>
<p>Prinzipiell gibt es also ein <em>Mapping</em> von HTTP-Anfragen auf SQL-Anfragen:</p>
<table>
<thead>
<tr>
<th>CRUD</th>
<th>SQL</th>
<th>MongoDB</th>
<th>HTTP</th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td>INSERT</td>
<td>insertOne(), insertMany()</td>
<td>POST</td>
</tr>
<tr>
<td>read</td>
<td>SELECT</td>
<td>findOne(), find()</td>
<td>GET</td>
</tr>
<tr>
<td>update</td>
<td>UPDATE</td>
<td>updateOne(), updateMany()</td>
<td>PUT (oder PATCH)</td>
</tr>
<tr>
<td>delete</td>
<td>DELETE</td>
<td>deleteOne(), deleteMany()</td>
<td>DELETE</td>
</tr>
</tbody>
</table>
<p>Zur Unterscheidung zwischen <code>PUT</code> und <code>PATCH</code> siehe z.B. <a href="https://www.geeksforgeeks.org/difference-between-put-and-patch-request/">hier</a> oder <a href="https://stackoverflow.com/questions/21660791/what-is-the-main-difference-between-patch-and-put-request">hier</a>.
Wir wollen uns ein Backend erstellen, über das wir unsere Daten verwalten. Dazu überlegen wir uns zunächst ein paar sogenannte <em>Endpunkte</em> (siehe Prinzipien von REST oben) und die Zugriffsmethoden, mit denen wir auf unsere Daten zugreifen wollen.</p>
<table>
<thead>
<tr>
<th> Methode</th>
<th> URL</th>
<th> Bedeutung</th>
</tr>
</thead>
<tbody>
<tr>
<td> GET</td>
<td> /posts</td>
<td> hole alle Datensätze</td>
</tr>
<tr>
<td> GET</td>
<td> /posts/11</td>
<td>hole den Datensatz mit der id=11</td>
</tr>
<tr>
<td> POST</td>
<td> /posts</td>
<td> füge einen neuen Datensatz hinzu</td>
</tr>
<tr>
<td> PUT</td>
<td> /posts/11</td>
<td> ändere den Datensatz mit der id=11</td>
</tr>
<tr>
<td> DELETE</td>
<td> /posts/11</td>
<td> lösche den Datensatz mit der id=11</td>
</tr>
</tbody>
</table>
<p>Der Wert der <code>id</code> ist natürlich nur ein Beispiel. Es soll für alle <code>id</code>-Werte funktionieren, die in unserem Datensatz enthalten sind. Korrekterweise beschreiben wir die Endpunkte mit variabler <code>id</code> besser durch <code>/posts/:id</code> oder <code>/posts/{id}</code>.</p>
<h2 id="ein-nodejs-projekt-mit-express">Ein Node.js-Projekt mit Express<a class="headerlink" href="#ein-nodejs-projekt-mit-express" title="Permanent link">&para;</a></h2>
<p>Wir starten damit, uns ein <code>node.js</code>-Projekt zu erstellen. Dazu erstellen wir uns zunächst einen Ordner <code>backend</code>, wechseln in diesen Ordner und führen dann <code>npm init</code> aus:</p>
<div class="highlight"><pre><span></span><code>mkdir backend
<span class="nb">cd</span> backend
npm init
</code></pre></div>
<p>Sie werden ein paar Sachen gefragt. Im Prinzip können Sie immer <code>Enter</code> drücken, außer beim <code>entry point</code>. Dort können Sie gleich <code>server.js</code> eingeben. Sie können das aber auch noch später in der <code>package.json</code> ändern.</p>
<div class="highlight"><pre><span></span><code>This utility will walk you through creating a package.json file.
It only covers the most common items, and tries to guess sensible defaults.

See <span class="sb">`</span>npm <span class="nb">help</span> init<span class="sb">`</span> <span class="k">for</span> definitive documentation on these fields
and exactly what they <span class="k">do</span>.

Use <span class="sb">`</span>npm install &lt;pkg&gt;<span class="sb">`</span> afterwards to install a package and
save it as a dependency <span class="k">in</span> the package.json file.

Press ^C at any <span class="nb">time</span> to quit.
package name: <span class="o">(</span>backend<span class="o">)</span> 
version: <span class="o">(</span><span class="m">1</span>.0.0<span class="o">)</span> 
description: Backend REST-API
entry point: <span class="o">(</span>index.js<span class="o">)</span> server.js
<span class="nb">test</span> command: 
git repository: 
keywords: rest api backend mongodb
author: J. Freiheit
license: <span class="o">(</span>ISC<span class="o">)</span> 
About to write to /Users/jornfreiheit/Sites/IKT22/05_Backend/00_skript/backend/package.json:

<span class="o">{</span>
  <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;backend&quot;</span>,
  <span class="s2">&quot;version&quot;</span>: <span class="s2">&quot;1.0.0&quot;</span>,
  <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Backend REST-API&quot;</span>,
  <span class="s2">&quot;main&quot;</span>: <span class="s2">&quot;server.js&quot;</span>,
  <span class="s2">&quot;scripts&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;test&quot;</span>: <span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
  <span class="o">}</span>,
  <span class="s2">&quot;keywords&quot;</span>: <span class="o">[</span>
    <span class="s2">&quot;rest&quot;</span>,
    <span class="s2">&quot;api&quot;</span>,
    <span class="s2">&quot;backend&quot;</span>,
    <span class="s2">&quot;mongodb&quot;</span>
  <span class="o">]</span>,
  <span class="s2">&quot;author&quot;</span>: <span class="s2">&quot;J. Freiheit&quot;</span>,
  <span class="s2">&quot;license&quot;</span>: <span class="s2">&quot;ISC&quot;</span>
<span class="o">}</span>


Is this OK? <span class="o">(</span>yes<span class="o">)</span> 
</code></pre></div>
<p>Die <code>package.json</code> wurde erstellt. Nun benötigen wir noch das Modul <a href="https://expressjs.com/de/">Express</a>. Express bietet uns eine unkomplizierte <em>Middleware</em> für die Weiterverwaltung von <code>http</code>-Anfragen an die Datenbank und zurück. </p>
<div class="highlight"><pre><span></span><code>npm install express --save
</code></pre></div>
<p>Die Option <code>--save</code> muss eigentlich nicht mehr angegeben werden, aber unter <a href="https://expressjs.com/de/">Express</a> steht es noch so. Sie erhalten eine Meldung in der Form:</p>
<div class="highlight"><pre><span></span><code>% npm install express --save

added <span class="m">57</span> packages, and audited <span class="m">58</span> packages <span class="k">in</span> 887ms

<span class="m">7</span> packages are looking <span class="k">for</span> funding
  run <span class="sb">`</span>npm fund<span class="sb">`</span> <span class="k">for</span> details

found <span class="m">0</span> vulnerabilities
</code></pre></div>
<p>In der <code>package.json</code> wurde die entsprechende Abhängigkeit eingetragen: </p>
<div class="tabbed-set" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">package.json</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Backend REST-API&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;server.js&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;keywords&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;rest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;api&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;mongodb&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;author&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;J. Freiheit&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;license&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ISC&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="nt">&quot;express&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.18.0&quot;</span><span class="w"></span>
</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h4 id="serverjs-erstellen-und-implementieren">server.js erstellen und implementieren<a class="headerlink" href="#serverjs-erstellen-und-implementieren" title="Permanent link">&para;</a></h4>
<p>Öffnen Sie nun das <code>backend</code>-Projekt in Ihrer IDE und erstellen Sie sich dort eine Datei <code>server.js</code> mit folgendem Inhalt:</p>
<div class="tabbed-set" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">server.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes&#39;</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`server running on http://localhost:</span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Das bedeutet, wir importieren <code>express</code> (Zeile <code>1</code>), erzeugen uns davon ein Objekt und speichern dieses in der Variablen <code>app</code> (Zeile <code>4</code>). Wir legen in einer Konstanten <code>PORT</code> die Portnummer <code>3000</code> fest (Zeile <code>5</code> - die Portnummer können Sie wählen). Das <code>backend</code> ist somit unter <code>http://localhost:3000</code> verfügbar. Das eigentliche Starten des Webservers erfolgt in den Zeilen <code>10-16</code> durch Aufruf der <code>listen()</code>-Funktion von <code>express</code>. Die Syntax der <code>listen()</code>-Funktion ist generell wie folgt:</p>
<div class="highlight"><pre><span></span><code>app.listen<span class="o">([</span>port<span class="o">[</span>, host<span class="o">[</span>, backlog<span class="o">]]][</span>, callback<span class="o">])</span>
</code></pre></div>
<p>Wir übergeben als ersten Parameter die <code>PORT</code>-Nummer (<code>3000</code>) und als zweiten Parameter eine (anonyme) Funktion als sogenannten <em>callback</em>. <em>Callbacks</em> sind <a href="../promises/#callbacks">hier</a> näher erläutert. Die anonyme Funktion wird durch die <code>listen()</code>-Funktion aufgerufen. Sollte ein Fehler aufgetreten sein (z.B. wenn der Port bereits belegt ist), wird der anonymen Funktion ein <code>error</code>-Objekt übergeben. Ist das der Fall, wird der Fehler auf der Konsole ausgegeben. Wird der anonymen Funktion kein Objekt übergeben, wurde der Webserver korrekt gestartet und die entsprechende Meldung erscheint auf der Konsole. </p>
<p>Beachten Sie auch die verwendete Syntax <code>${PORT}</code> im sogenannte <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">template literal</a>. Beachten Sie, dass <em>template literals</em> nicht in einfachen (<code>'</code>) oder doppelten (<code>"</code>) Anführungsstrichen stehen, sondern in <code>&#96;</code> (<em>backticks</em>). </p>
<h3 id="router">Router<a class="headerlink" href="#router" title="Permanent link">&para;</a></h3>
<p>Noch lässt sich unser Programm aber nicht ausführen. Wir benötigen im Projektordner noch eine Datei <code>routes.js</code>. Diese wird nämlich in der <code>server.js</code> bereits in Zeile <code>2</code> eingebunden und in Zeile <code>8</code> verwendet. </p>
<div class="tabbed-set" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><label for="__tabbed_3_1">routes.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="c1">// eine GET-Anfrage</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Hello FIW!&quot;</span> <span class="p">});</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Beim <code>Router</code> handelt es sich um eine <em>Middleware</em> (siehe <a href="https://expressjs.com/de/guide/using-middleware.html">hier</a>), die die Routen verwaltet und <code>request</code>-Objekte an die entsprechende Routen weiterleitet und <code>response</code>-Objekte empfängt. In unserer <code>routes.js</code> haben wir zunächst eine <code>GET</code>-Anfrage implementiert (Zeile <code>5</code>). Das <code>request</code>-Objekt heißt hier <code>req</code>. Das verwenden wir aber gar nicht. Das <code>respones</code>-Objekt heißt hier <code>res</code> und wird durch die Anfrage erzeugt. Wir senden in der <code>response</code> ein JavaScript-Objekt zurück, das einen Schlüssel <code>message</code> enthält. </p>
<p>In der <code>server.js</code> haben wir mit <code>app.use(express.json())</code> (Zeile <code>7</code>) angegeben, dass alle JavaScript-Objekte in der <code>response</code> nach JSON umgewandelt werden sollen. Wenn nun die URL <code>localhost:3000</code> aufgerufen wird, dann wird ein <code>request</code> ausgelöst, den wir hier mit <code>Hello FIW!</code> als <code>response</code> beantworten (Zeilen <code>5-8</code>). </p>
<p>Wichtig ist, dass wir <code>router</code> mit <code>module.exports</code> exportieren, damit es von anderen Modulen importiert und genutzt werden kann. Siehe dazu z.B. <a href="https://www.sitepoint.com/understanding-module-exports-exports-node-js/">hier</a>. Meine Empfehlung ist, <strong>(noch) nicht</strong> das <a href="https://www.sitepoint.com/understanding-es6-modules/">neue ESM6-Format</a> zu nutzen! </p>
<p>Noch "läuft" unser Backend aber noch nicht. Wir müssen es erst starten. </p>
<h3 id="starten-des-projektes-und-installation-von-nodemon">Starten des Projektes und Installation von nodemon<a class="headerlink" href="#starten-des-projektes-und-installation-von-nodemon" title="Permanent link">&para;</a></h3>
<p>Das Projekt lässt sich nun starten. Wir geben dazu im Terminal im <code>backend</code>-Ordner</p>
<div class="highlight"><pre><span></span><code>node server.js
</code></pre></div>
<p>ein. Im Terminal erscheint </p>
<div class="highlight"><pre><span></span><code>server running on http://localhost:3000 
</code></pre></div>
<p>und wenn Sie im Browser die URL <code>http://localhost:3000/</code> eingeben, wird dort</p>
<p><img alt="backend" src="../files/91_backend.png" /></p>
<p>angezeigt. Sie können auch Postman öffnen und <code>http://localhost:3000</code> eintragen (<code>GET</code>-Methode):</p>
<p><img alt="backend" src="../files/92_postman.png" /></p>
<p>Wann immer wir jetzt jedoch etwas an der Implementierung ändern, müssen wir im Terminal zunächst den Webserver mit </p>
<div class="highlight"><pre><span></span><code>Strg-C      // bzw. Control-C
</code></pre></div>
<p>stoppen, um ihn dann wieder mit <code>node server.js</code> zu starten. Um das zu umgehen, gibt es das Paket <a href="https://www.npmjs.com/package/nodemon">nodemon</a>. Da es nur sinnvoll während der Entwicklung eingesetzt werden kann (und sollte), installieren wir es als eine <em>development dependency</em>:</p>
<div class="highlight"><pre><span></span><code>npm install --save-dev nodemon
</code></pre></div>
<p>Die <code>package.json</code> sieht daraufhin so aus:</p>
<div class="tabbed-set" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><label for="__tabbed_4_1">package.json</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Backend REST-API&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;server.js&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;keywords&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;rest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;api&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;mongodb&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;author&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;J. Freiheit&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;license&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ISC&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;express&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.18.0&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="nt">&quot;nodemon&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^2.0.16&quot;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Zur Verwendung von <code>nodemon</code> fügen wir in die <code>package.json</code> unter <code>"scripts"</code> noch die Eigenschaft <code>watch</code> (frei gewählt) und den dazugehörigen Wert <code>nodemon server.js</code> ein:</p>
<div class="tabbed-set" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><label for="__tabbed_5_1">package.json</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Backend REST-API&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;server.js&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="nt">&quot;watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nodemon ./server.js&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;keywords&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;rest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;api&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;mongodb&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;author&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;J. Freiheit&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;license&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ISC&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;express&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.18.0&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;nodemon&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^2.0.16&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Nun lässt sich die Anwendung mithilfe von <code>nodemon</code> per </p>
<div class="highlight"><pre><span></span><code>npm run watch
</code></pre></div>
<p>starten und muss auch nicht mehr gestoppt und neu gestartet werden, wenn Änderungen an der Implementierungen durchgeführt wurden. Die Ausgabe im Terminal nach Eingabe von <code>npm run watch</code> ist ungefähr so:</p>
<div class="highlight"><pre><span></span><code>&gt; backend@1.0.0 watch
&gt; nodemon ./server.js

<span class="o">[</span>nodemon<span class="o">]</span> <span class="m">2</span>.0.16
<span class="o">[</span>nodemon<span class="o">]</span> to restart at any time, enter <span class="sb">`</span>rs<span class="sb">`</span>
<span class="o">[</span>nodemon<span class="o">]</span> watching path<span class="o">(</span>s<span class="o">)</span>: *.*
<span class="o">[</span>nodemon<span class="o">]</span> watching extensions: js,mjs,json
<span class="o">[</span>nodemon<span class="o">]</span> starting <span class="sb">`</span>node ./server.js<span class="sb">`</span>
server running on http://localhost:3000
</code></pre></div>
<p>Hier nur zum Verständnis. Angenommen, wir ändern bspw. in der <code>server.js</code> die Zeile <code>8</code> zu </p>
<div class="highlight"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">);</span>
</code></pre></div>
<p>, dann würden alle Routen, die wir in <code>routes.js</code> definieren, unter <code>localhost:3000/api</code> verfügbar sein. Wenn wir dann also z.B. in der <code>routes.js</code> die Zeile <code>5</code> zu </p>
<div class="highlight"><pre><span></span><code><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/fiw&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</code></pre></div>
<p>ändern, dann ist der GET-Endpunkt <code>localhost:3000/api/fiw</code>. </p>
<h3 id="mongoose-installieren">Mongoose installieren<a class="headerlink" href="#mongoose-installieren" title="Permanent link">&para;</a></h3>
<p><a href="https://www.mongodb.com/de-de">MongoDB</a> ist die am meisten verwendete <em>NoSQL (not only SQL)</em> Datenbank. Sie basiert nicht auf Relationen, Tabellen und ihren Beziehungen zueinander (ist also keine <em>relationale</em> Datenbank), sondern speichert Dokumente in JSON-ähnlichem Format. Die <a href="https://github.com/mongodb/mongo">Community Edition der MongoDB</a> ist Open Source und kostenlos verfügbar. 
Sollten Sie mit <em>Visual Studio Code</em> arbeiten, sollten Sie sich am besten die <a href="https://code.visualstudio.com/docs/azure/mongodb">MongoDB for VS Code</a>-Ereiterung installieren. </p>
<p>Zur Verwendung von <em>MongoDB</em> im Backend verwenden wir das Modul <a href="https://mongoosejs.com/">Mongoose</a>. Wir installieren <em>Mongoose</em> mithilfe von</p>
<div class="highlight"><pre><span></span><code>npm install mongoose --save
</code></pre></div>
<p>In die <code>package.json</code> wird das Paket und die entsprechende Abhängigkeit eingetragen:</p>
<div class="tabbed-set" data-tabs="6:1"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><label for="__tabbed_6_1">package.json</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Backend REST-API&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;server.js&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nodemon ./server.js&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;keywords&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;rest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;api&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;mongodb&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;author&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;J. Freiheit&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;license&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ISC&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;express&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.18.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="nt">&quot;mongoose&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^6.3.1&quot;</span><span class="w"></span>
</span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;nodemon&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^2.0.16&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p><em>Mongoose</em> stellt eine einfach zu verwendende Schnittstelle zwischen Node.js und MongoDB bereit. Die
MongoDB benötigen wir aber trotzdem (wir könnten jedoch auch eine Cloud von MongoDB oder z.B. <code>mlab.com</code> verwenden). Bevor wir uns mit der MongoDB verbinden, erstellen wir zunächst noch eine Datenbank. </p>
<h3 id="mongodb-compass">MongoDB Compass<a class="headerlink" href="#mongodb-compass" title="Permanent link">&para;</a></h3>
<p>Um sich Ihre MongoDB-datenbanken anzuschauen, empfehle ich Ihnen das Tool <a href="https://www.mongodb.com/de-de/products/compass">MongoDB Compass</a>. Download und Installation sind normalerweise einfach. </p>
<h3 id="dotenv-fur-sichere-zugangsdaten">Dotenv für sichere Zugangsdaten<a class="headerlink" href="#dotenv-fur-sichere-zugangsdaten" title="Permanent link">&para;</a></h3>
<p>Für die "geheimen" Zugangsdaten (die jetzt noch gar nicht "geheim" sind) verwenden wir das <a href="https://www.npmjs.com/package/dotenv">dotenv</a>-Paket:</p>
<div class="highlight"><pre><span></span><code>npm install dotenv --save
</code></pre></div>
<p>Im Projektordner erstellen wir und eine Datei <code>.env</code> (mit vorangestelltem Punkt!) und schreiben darin:</p>
<div class="tabbed-set" data-tabs="7:1"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><label for="__tabbed_7_1">.env</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">DB_CONNECTION</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="o">:</span><span class="c1">//127.0.0.1:27017/posts</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Beachten Sie, dass der Wert nicht in Hochkomma steht und dass auch kein Semikolon folgt! 
Wir fügen <code>dotenv</code> in die <code>server.js</code> ein und greifen mithilfe von <code>process.env.DB_CONNECTION</code> auf den Wert von <code>DB_CONNECTION</code> zu:</p>
<div class="tabbed-set" data-tabs="8:1"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><label for="__tabbed_8_1">server.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="hll"><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>
</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Server started and listening on port </span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb"> ... `</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// connect to mongoDB</span>
<span class="hll"><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;connection error:&#39;</span><span class="p">));</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;connected to DB&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>In Zeile <code>4</code> wird das <code>dotenv</code>-Paket importiert. Mithilfe der <code>config()</code>-Funktion wird die <code>.env</code>-Datei eingelesen. Auf die in der <code>.env</code>-Datei hinterlegten Schlüssel-Werte-Paare (mit <code>=</code> dazwischen) kann dann mittels <code>process.env.&lt;Schlüssel&gt;</code> zugegriffen werden (siehe Zeile <code>21</code>). </p>
<p>Beachten Sie, die <code>.env</code>-Datei in die <code>.gitignore</code> einzutragen. Die <code>.env</code>-Datei sollte <strong>nicht</strong> committed werden!</p>
<h3 id="ein-model-erstellen">Ein Model erstellen<a class="headerlink" href="#ein-model-erstellen" title="Permanent link">&para;</a></h3>
<p>Mongoose ist Schema-basiert. Ein Schema kann man sich wie ein Datenmodell vorstellen. Tatsächlich wird es verwendet, um ein entsprechendes Mongoose-Model zu erstellen. Ein Schema wird unter Aufruf des Konstruktors (<code>new Schema()</code>) in Mongoose erstellt. Unter Verwendung des Schemas wird dann mithilfe der <code>model()</code>-Funktion das Datenmodell erzeugt. </p>
<p>Wir werden im Folgenden zeigen, wie ein Schema für <code>posts</code> erstellt wird. Das Datenmodell heißt dann <code>Post</code>. Um später auch weitere Schemata, z.B. für <code>user</code> o.ä. zu entwicklen und diese zu trennen, erstellen wir das Schema in einem eigenen Ordner <code>models</code>. Das bedeutet, wir erstellen im Projektordner </p>
<ul>
<li>ein Ordner <code>models</code> und</li>
<li>darin eine Datei <code>models/posts.js</code></li>
</ul>
<p>Die Datei <code>posts.js</code> bekommt folgenden Inhalt:</p>
<div class="tabbed-set" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><label for="__tabbed_9_1">models/posts.js</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">location</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">image_id</span><span class="o">:</span> <span class="nb">String</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Post&#39;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">);</span>
</code></pre></div>
</div>
</div>
<p>Weiterführende Informationen zu Mongoose-Models finden Sie z.B. <a href="https://mongoosejs.com/docs/models.html">hier</a>. Das Thema Schema wird z.B. <a href="https://mongoosejs.com/docs/guide.html">hier</a> näher erläutert. </p>
<h3 id="zugriffe-auf-die-datenbank">Zugriffe auf die Datenbank<a class="headerlink" href="#zugriffe-auf-die-datenbank" title="Permanent link">&para;</a></h3>
<p>Nun haben wir alles, was wir benötigen, um unsere Anfragen zu implementieren. Wir nutzen den <code>express.Router</code>, um die Routen zu definieren und können mithilfe des Mongoose-Models auf die MongoDB zugreifen. Wir werden nun sukzessive alle Anfragen in die <code>routes.js</code> einfügen. </p>
<h4 id="r-read-all">R - read all<a class="headerlink" href="#r-read-all" title="Permanent link">&para;</a></h4>
<p>Wir beginnen mit der Anfrage, alle Daten aus der Datenbank auszulesen. Für die MongoDB erfolgt dies mit der Funktion <code>find()</code>. In <code>routes.js</code> ändern wir unsere <code>GET</code>-Anfrage wie folgt: </p>
<div class="tabbed-set" data-tabs="10:1"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><label for="__tabbed_10_1">routes.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="hll"><span class="kd">const</span> <span class="nx">Post</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./models/posts&#39;</span><span class="p">);</span>
</span>
<span class="c1">// GET all posts</span>
<span class="hll"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">    <span class="kd">const</span> <span class="nx">allPosts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
</span><span class="hll">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">allPosts</span><span class="p">);</span>
</span><span class="hll">    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">allPosts</span><span class="p">);</span>
</span><span class="hll"><span class="p">});</span>
</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Beachten Sie, dass wir dazu nun das <code>Post</code>-Model in die <code>routes.js</code> einbinden (Zeile <code>3</code>). Die Route wird mit <code>localhost:3000/posts</code> definiert. Die anonyme Callback-Funktion enthält noch zwei Schlüsselwörter: <code>async</code> und <code>await</code>. Die Funktion <code>find()</code> ist ein <em>Promise</em> (siehe dazu <a href="../promises/#promises">hier</a>). Die Funktion <code>find()</code> wird asynchron ausgeführt und "irgendwann" ist entweder das Ergebnis dieser Funktion verfügbar oder die Funktion gibt einen Fehler zurück. Auf eines der beiden wird gewartet (<code>await</code>). Nur eine als <code>async</code> deklarierte Funktion darf einen <code>await</code>-Aufruf enthalten (siehe dazu z.B. <a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Statements/async_function">hier</a>).</p>
<p>Die Ausgabe der Werte auf die Konsole (Zeile <code>8</code>) ist natürlich nicht erforderlich und Sie können sie auch löschen, wenn Sie wollen. Wenn Sie nun in Postman <code>GET http://localhost:3000/posts</code> aufrufen, erscheinen alle Einträge aus der Datenbank. Allerdings haben wir dort noch keine Einträge. Wir bekommen deshalb ein leeres Array <code>[]</code> zurück.</p>
<h4 id="c-create">C - create<a class="headerlink" href="#c-create" title="Permanent link">&para;</a></h4>
<p>Als nächstes implementieren wir einen Endpunkt, an dem wir einen neuen Datensatz in die Datenbank anlegen können. Dafür gibt es die http-Methode <code>POST</code>. Wir führen also nicht mehr eine <code>GET</code>-, sondern eine <code>POST</code>-Anfrage durch. Bei dieser <code>POST</code>-Anfrage wird der neue Datensatz an den Webserver mitgeschickt. Dies erfolgt im <code>body</code> des <code>request</code>-Objektes. Das Schreiben des Datensatzes in die Datenbank erfolgt mithilfe der <code>save()</code>-Funktion von MongoDB. </p>
<div class="tabbed-set" data-tabs="11:1"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><label for="__tabbed_11_1">routes.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// POST one post</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">newPost</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Post</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
        <span class="nx">location</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
        <span class="nx">image_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">image_id</span>
    <span class="p">})</span>
    <span class="k">await</span> <span class="nx">newPost</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newPost</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>In den Zeilen <code>15-17</code> werden die Daten aus dem <code>body</code> des <code>request</code>-Objektes ausgelesen und mit diesen Daten ein neues <code>Post</code>-Objekt erzeugt. Dieses neue <code>Post</code>-Objekt (<code>newPost</code>) wird in Zeile <code>19</code> in die Datenbank gespeichert und in Zeile <code>20</code> als <code>response</code> zurückgeschickt.  </p>
<p>Nun geben wir in Postman <code>POST http://localhost:3000/posts</code> ein und befüllen den <code>Body</code> z.B. mit:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;H-Gebäude&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Campus Wilhelminenhof&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="w"> </span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<p>Achten Sie darauf, dass in der zweiten Menüzeile rechts <code>JSON</code> ausgewählt ist (im Bild blau) - nicht <code>Text</code>. Wir klicken auf <code>Send</code> und es erscheint:</p>
<p><img alt="postman" src="../files/95_postman.png" /></p>
<p>Schauen Sie auch in MongoDB Compass nach, ob der Datensatz dort erscheint:</p>
<p><img alt="phpmyadmin" src="../files/221_mongodb.png" /></p>
<h4 id="r-read-one">R - read one<a class="headerlink" href="#r-read-one" title="Permanent link">&para;</a></h4>
<p>Wir erweitern die <code>routes.js</code> um einen Endpunkt, der uns für eine gegebene <code>id</code> den entsprechenden Datensatz zurückliefert. Die <code>_id</code> werden von MongoDB automatisch vergeben und sind recht kryptisch, also z.B. <code>"626bdb36cd1af60df758d300"</code>. Wir können natürlich nach jedem beliebigen Wert für jeden Schlüssel in der Datenbank suchen. Wir nehmen hier beispielhaft die <code>_id</code>. </p>
<p>Die <code>id</code> wird aus der URL des Endpunktes ausgelesen, d.h. wenn wir bspw. den Endpunkt <code>GET http://localhost:3000/posts/626bdb36cd1af60df758d300</code> eingeben, dann soll der Datensatz mit der <code>_id: 626bdb36cd1af60df758d300</code> im JSON-Format zurückgegeben werden. Wir nutzen dazu parametrisierte Routen und lesen die <code>id</code> aus der Parameterliste aus. Paremtrisierte Routen werden per <code>:</code> und dann den Namen des Parameters (hier <code>id</code>) erstellt. Um dann den Wert des Parametrs <code>id</code> aus der Parameterliste auszulesen, wird <code>params</code> verwendet. Im folgenden Code lassen wir <code>req.params</code> auf die Konsole ausgeben, um die Funktionsweise zu erläutern. Diese Ausgabe kann natürlich gelöscht werden (Zeile <code>27</code>). </p>
<div class="tabbed-set" data-tabs="12:1"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><label for="__tabbed_12_1">routes.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// POST one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/posts/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Zum Finden eines einzelnen Datensatzes wird in MongoDB die Funktion <code>findOne()</code> verwendet (siehe <a href="https://docs.mongodb.com/manual/reference/method/db.collection.findOne">hier</a>). Wird der Datensatz gefunden, d.h. existiert die entsprechende <code>_id</code>, dann wird dieser in der <code>response</code> zurückgesendet (Zeile <code>28</code>). Existiert er nicht, wird der HTTP-Statuscode <code>404</code> gesendet (Zeile <code>30</code>) und ein JSON mit der <code>error</code>-Nachricht <code>Post does not exist!</code> (Zeile <code>31</code>). </p>
<p>Nach Neustart des Servers geben wir in Postman z.B. <code>GET http://localhost:3000/posts/626bdb36cd1af60df758d300</code> ein (bei Ihnen sind die <code>_id</code>-Werte andere!) und erhalten:</p>
<p><img alt="postman" src="../files/97_postman.png" /></p>
<p>Probieren Sie auch einmal <code>GET http://localhost:3000/posts/0</code> aus, um die Fehlermeldung als JSON zu sehen. </p>
<h4 id="u-update">U - update<a class="headerlink" href="#u-update" title="Permanent link">&para;</a></h4>
<p>Um einen bereits existierenden Datensatz zu ändern, kann entweder die HTTP-Anfrage <code>PUT</code> oder <code>PATCH</code> verwendet werden. Zur Unterscheidung zwischen <code>PUT</code> und <code>PATCH</code> siehe z.B. <a href="https://www.geeksforgeeks.org/difference-between-put-and-patch-request/">hier</a> oder <a href="https://stackoverflow.com/questions/21660791/what-is-the-main-difference-between-patch-and-put-request">hier</a>. Um einen Datensatz in der MongoDB zu ändern, stehen prinzipiell mehrere Funktionen zur Verfüging:</p>
<ul>
<li><code>updateOne()</code>: ändert einzelne (oder alle) Teile eines Datensatzes und sendet die <code>_id</code> zurück, falls ein neur Datensatz angelegt wurde,</li>
<li><code>findOneAndUpdate()</code>: ändert einzelne (oder alle) Teile eines Datensatzes und sendet den kompletten Datensatz zurück,</li>
<li><code>replaceOne()</code>: ändert den kompletten Datensatz. </li>
</ul>
<p>In der folgenden Implementierung haben wir uns für die HTTP-Anfragemethode <code>PATCH</code> und für die MongoDB-Funktion <code>updateOne()</code> entschieden. Diese Funktion erwartet als ersten Parameter einen <code>&lt;filter&gt;</code>, d.h. die Werte, nach denen nach einem Datensatz gesucht werden soll. Im folgenden Beispiel ist der Filter die <code>_id</code>. Dazu wird erneute ein Parameter <code>id</code> für die URL definiert. Der zweite Parameter der <code>updateOne()</code>-Funktion sind die zu ändernden Werte für diesen Datensatz. In der folgenden Implementierung werden diese zu ändernden Werte als ein JSON dem <code>body</code> des <code>request</code>-Objektes übergeben. Um zu ermöglichen, dass ein, zwei oder drei Schlüssel-Werte-Paare in diesem JSON enthalten sein können, prüfen wir die Einträge im <code>body</code> und setzen daraus ein neues <code>member</code>-Objekt zusammen, wenn es bereits in der Datenbank existiert (deshalb zunächst <code>findOne()</code>):</p>
<div class="tabbed-set" data-tabs="13:1"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><label for="__tabbed_13_1">router.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// PATCH (update) one post</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="s1">&#39;/posts/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">})</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">image_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">image_id</span>
        <span class="p">}</span>

        <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">},</span> <span class="nx">post</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Wir können diese Funktion in Postman ausprobieren, indem wir im <code>body</code> z.B. das JSON </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test_neu&quot;</span><span class="w"> </span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<p>mit unserem Request übergeben und <code>PATCH http://localhost:3000/posts/626bdb36cd1af60df758d300</code> wählen (bei Ihnen eine andere <code>id</code>!). Der Datensatz mit der <code>_id=626bdb36cd1af60df758d300</code> wird dann aktualisiert. </p>
<p><img alt="postman" src="../files/98_postman.png" /></p>
<p>Schauen Sie auch in der Datenbank nach (z.B. in MongoDB Compass) und wählen auch ruhig nochmal <code>GET http://localhost:3000/posts</code> (z.B. in Postman).</p>
<h4 id="d-delete-one">D - delete one<a class="headerlink" href="#d-delete-one" title="Permanent link">&para;</a></h4>
<p>Jetzt implementieren wir noch den Endpunkt, um einen Datensatz zu löschen. Dazu werden die HTTP-Anfragemethode <code>DELETE</code> und die MongoDB-Funktion <code>deleteOne()</code> verwendet. Im folgenden Beispiel wird der Datensatz erneut über die <code>_id</code> ermittelt und dafür erneut die parametrisierte URL ausgelesen:</p>
<div class="tabbed-set" data-tabs="14:1"><input checked="checked" id="__tabbed_14_1" name="__tabbed_14" type="radio" /><label for="__tabbed_14_1">routes.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// DELETE one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/posts/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">})</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">204</span><span class="p">).</span><span class="nx">send</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Wenn wir nun in Postman z.B. <code>DELETE http://localhost:3000/members/626bdb36cd1af60df758d300</code> wählen (bei Ihnen eine andere <code>id</code>!), wird der Datensatz mit der <code>_id=626bdb36cd1af60df758d300</code> aus der Datenbank gelöscht. </p>
<p>Hier nochmal die vollständige <code>routes.js</code>:</p>
<details><summary>routes.js</summary><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">Post</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./models/posts&#39;</span><span class="p">);</span>

<span class="c1">// GET all posts</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">allPosts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">allPosts</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">allPosts</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// POST one post</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">newPost</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Post</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
        <span class="nx">location</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
        <span class="nx">image_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">image_id</span>
    <span class="p">})</span>
    <span class="k">await</span> <span class="nx">newPost</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newPost</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// POST one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/posts/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// PATCH (update) one post</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="s1">&#39;/posts/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">})</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">image_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">image_id</span>
        <span class="p">}</span>

        <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">},</span> <span class="nx">post</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// DELETE one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/posts/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">})</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">204</span><span class="p">).</span><span class="nx">send</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>    
</code></pre></div>
</td></tr></table>
</details>
<h3 id="cross-origin-resource-sharing-cors">Cross-Origin Resource Sharing (CORS)<a class="headerlink" href="#cross-origin-resource-sharing-cors" title="Permanent link">&para;</a></h3>
<p>Die <em>Same Origin Policy (SOP)</em> ist ein Sicherheitskonzept, das clientseitig Skriptsprachen (also z.B. JavaScript oder CSS) untersagt, Ressourcen aus verschiedenen Herkunften zu verwenden, also von verschiedenen Servern. Dadurch soll verhindert werden, dass fremde Skripte in die bestehende Client-Server-Kommunikation eingeschleust werden. Gleiche <em>Herkunft (origin)</em> bedeutet, dass das gleiche Protokoll (z.B. <code>http</code> oder <code>https</code>), von der gleichen Domain (z.B. <code>localhost</code> oder <code>htw-berlin</code>) sowie dem gleichen Port (z.B. <code>80</code> oder <code>4200</code>) verwendet werden. Es müssen alle drei Eigenschaften übereinstimmen. </p>
<p>Mit dem Aufkommen von Single Page Applications und dem darin benötigten AJAX kam jedoch der Bedarf auf, die SOP aufzuweichen. Es sollte möglich sein, dass z.B. JavaScript sowohl client-seitig das DOM ändert als auch einen Request an den Server (das Backend) sendet. Der Kompromiss, der dafür gefunden wurde, nennt sich <em>Cross-Origin Resource Sharing (CORS)</em>. Damit ist es möglich, für einige oder alle Anfragen zu definieren, dass sie im Sinne der SOP trotzdem erlaub sein sollen. </p>
<p>Um CORS für Ihr Backend zu aktivieren, wechseln Sie im Terminal in Ihren <code>backend</code>-Ordner und geben dort</p>
<div class="highlight"><pre><span></span><code>npm install cors
</code></pre></div>
<p>ein. Öffnen Sie dann die <code>server.js</code> und fügen Sie die hervorgehobenen Zeilen ein:</p>
<div class="tabbed-set" data-tabs="15:1"><input checked="checked" id="__tabbed_15_1" name="__tabbed_15" type="radio" /><label for="__tabbed_15_1">server.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="hll"><span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">);</span>
</span><span class="kd">const</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="hll"><span class="c1">// enable cors for all requests</span>
</span><span class="hll"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>
</span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`server running on http://localhost:</span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// connect to mongoDB</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;connection error:&#39;</span><span class="p">));</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;connected to DB&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Wenn Sie z.B. nur die <code>get</code>-Anfrage teilen wollen, dann wählen Sie nicht <code>app.use(cors());</code>, sondern </p>
<div class="highlight"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="nx">cors</span><span class="p">(),</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Hello FIW!&quot;</span> <span class="p">});</span>
    <span class="p">});</span>
</code></pre></div>
<p>Mehr zum CORS-Paket von node.js bzw. express finden Sie <a href="https://expressjs.com/en/resources/middleware/cors.html">hier</a>.</p>
<div class="admonition success">
<p class="admonition-title">Success<p>Das bis hier erstellte Backend ist unter <a href="https://github.com/jfreiheit/IKT-PWA-Backend.git">https://github.com/jfreiheit/IKT-PWA-Backend.git</a> verfügbar. </p>
</p>
</div>
<h2 id="erweiterung-um-das-speichern-von-bildern">Erweiterung um das Speichern von Bildern<a class="headerlink" href="#erweiterung-um-das-speichern-von-bildern" title="Permanent link">&para;</a></h2>
<p>Bis jetzt haben wir nur Daten im JSON-Format zwischen Frontend und Backend ausgetauscht und auch nur solche Daten in der MongoDB gespeichert. Bilder (und auch andere Dateien) sind <a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData/Using_FormData_Objects">FormData-Objects</a> im <code>multipart/form-data</code>-Format. Zur Behandlung solcher Daten verwenden wir ein <em>Middleware</em> für unser Backend, namens <a href="https://www.npmjs.com/package/multer">Multer</a>. </p>
<div class="admonition hint">
<p class="admonition-title">Hint<p>Wenn Sie nur am Code für unser Backend interessiert sind, dann können Sie auch direkt zu <a href="./#zusammenfuhren-der-funktionalitaten">Zusammenführen der Funktionalitäten</a> springen. Im Folgenden werden die Entstehung aber näher erläutert und verschiedene Varianten diskutiert. </p>
</p>
</div>
<p>MongoDB speichert Daten bis zu einer Größe von <code>16Mb</code> im Binärformat. Um auch größere Dateien (Bilder, Videos, pdf, ...) speichern zu können, werden die Dateien in <em>chunks</em> zerlegt und können dann aus diesen Stücken wieder zusammengesetzt werden. Dafür gibt es in der MongoDB eine <a href="https://docs.mongodb.com/manual/core/gridfs/">GridFS</a>-Spezifikation (siehe auch <a href="https://medium.com/@kavitanambissan/uploading-and-retrieving-a-file-from-gridfs-using-multer-958dfc9255e8">hier</a> oder <a href="https://www.topcoder.com/thrive/articles/storing-large-files-in-mongodb-using-gridfs">hier</a>). Zur Verwendung von GridFS gibt es die beiden Pakte <a href="https://www.npmjs.com/package/multer-gridfs-storage">multer-gridfs-storage</a> und <a href="https://www.npmjs.com/package/gridfs-stream">gridfs-stream</a>. </p>
<p>Wir installieren im Backend-Projekt alle drei Pakete und zeigen im Folgenden deren Verwendung:</p>
<div class="highlight"><pre><span></span><code>npm install multer multer-gridfs-storage gridfs-stream
</code></pre></div>
<p>Die <code>package.json</code> sollte nun ungefähr so aussehen:</p>
<div class="tabbed-set" data-tabs="16:1"><input checked="checked" id="__tabbed_16_1" name="__tabbed_16" type="radio" /><label for="__tabbed_16_1">package.json</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;backend&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Backend REST-API&quot;</span><span class="p">,</span>
  <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;server.js&quot;</span><span class="p">,</span>
  <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;watch&quot;</span><span class="o">:</span> <span class="s2">&quot;nodemon ./server.js&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test&quot;</span><span class="o">:</span> <span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;keywords&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;rest&quot;</span><span class="p">,</span>
    <span class="s2">&quot;api&quot;</span><span class="p">,</span>
    <span class="s2">&quot;backend&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mongodb&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;repository&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;git&quot;</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="s2">&quot;https://github.com/jfreiheit/IKT-PWA-Backend.git&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;J. Freiheit&quot;</span><span class="p">,</span>
  <span class="s2">&quot;license&quot;</span><span class="o">:</span> <span class="s2">&quot;ISC&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;cors&quot;</span><span class="o">:</span> <span class="s2">&quot;^2.8.5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dotenv&quot;</span><span class="o">:</span> <span class="s2">&quot;^16.0.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;express&quot;</span><span class="o">:</span> <span class="s2">&quot;^4.18.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gridfs-stream&quot;</span><span class="o">:</span> <span class="s2">&quot;^1.1.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mongoose&quot;</span><span class="o">:</span> <span class="s2">&quot;^6.3.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;multer&quot;</span><span class="o">:</span> <span class="s2">&quot;^1.4.4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;multer-gridfs-storage&quot;</span><span class="o">:</span> <span class="s2">&quot;^5.0.2&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;devDependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;nodemon&quot;</span><span class="o">:</span> <span class="s2">&quot;^2.0.16&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Wir kümmern uns nun zunächst darum, Bilder in die MongoDB <em>hochzuladen</em>.</p>
<h3 id="upload-von-bildern">Upload von Bildern<a class="headerlink" href="#upload-von-bildern" title="Permanent link">&para;</a></h3>
<p>Für den Upload der Bilder erstellen wir zunächst einen Ordner <code>middleware</code> und darin eine Datei <code>upload.js</code>. In dieser Datei wird unter Verwendung von <code>Multer</code> ein <code>GridFsStorage</code> eingerichtet. Die zu verwendende <em>Collection</em> benennen wir hier <code>fileupload</code> (siehe <code>bucketName</code>). Sie können diesen Namen frei wählen. Beachten Sie dann aber im Folgenden überall die Verwendung von <code>fileupload</code> (in der MongoDB entstehen die Collections <code>fileupload.files</code> und <code>fileupload.chunks</code> - siehe z.B. <a href="https://medium.com/@kavitanambissan/uploading-and-retrieving-a-file-from-gridfs-using-multer-958dfc9255e8">hier</a> oder <a href="https://www.topcoder.com/thrive/articles/storing-large-files-in-mongodb-using-gridfs">hier</a>).</p>
<div class="tabbed-set" data-tabs="17:1"><input checked="checked" id="__tabbed_17_1" name="__tabbed_17" type="radio" /><label for="__tabbed_17_1">middleware/upload.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">multer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;multer&quot;</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span>
    <span class="nx">GridFsStorage</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;multer-gridfs-storage&quot;</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">GridFsStorage</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span>
    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="nx">file</span><span class="o">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">mimetype</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mf">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;file.mimetype === -1&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">-jf-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">bucketName</span><span class="o">:</span> <span class="s1">&#39;posts&#39;</span><span class="p">,</span>
            <span class="nx">filename</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">-jf-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
        <span class="p">};</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">multer</span><span class="p">({</span> <span class="nx">storage</span> <span class="p">});</span>
</code></pre></div>
</td></tr></table>
<p>Beachten Sie, dass wir beim Upload der Bilder für diese Bilder Dateinamen mithilfe von <code>${Date.now()}-jf-${file.originalname}</code> erstellen bzw. festlegen. Damit diese Dateinamen eindeutig sind, wird mithilfe von <code>Date.now()</code> der aktuelle Zeitstempel verwendet. Der String <code>-jf-</code> in der Mitte kann natürlich auch durch Ihre Initialen ersetzt (oder weggelassen) werden. Außerdem wird auch noch der originale Dateiname verwendet. Insgesamt sollte sichergestellt werden, dass die Dateinamen eindeutig sind (deshalb auch <code>Date.now()</code>). </p>
<p>In Zeile <code>10</code> werden die Dateitypen festgelegt, die akzeptiert werden, hier <code>png</code> und <code>jpeg</code>. Diese Liste kann erweitert oder eingegrenzt werden.</p>
<p>Diese <em>Middleware</em> nutzen wir nun für den <code>POST</code>-Request des Bildes und erstellen einen Ordner <code>routes</code> und darin eine Datei <code>upload.routes.js</code> mit folgendem Inhalt:</p>
<div class="tabbed-set" data-tabs="18:1"><input checked="checked" id="__tabbed_18_1" name="__tabbed_18" type="radio" /><label for="__tabbed_18_1">routes/upload.route.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middleware/upload&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">upload</span><span class="p">.</span><span class="nx">single</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// req.file is the `file` file</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;no file selected&quot;</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;req.file&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">imgUrl</span> <span class="o">=</span> <span class="sb">`http://localhost:4000/download/</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">filename</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">url</span><span class="o">:</span> <span class="nx">imgUrl</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<p>In Zeile <code>5</code> wird die <em>multer-Middleware</em> mit <code>update.single('file')</code> aufgerufen. Neben der Funktion <code>.single(fieldname)</code> stehen auch die Funktionen <code>.array(fieldname[, maxCount])</code> und <code>.fields(field)</code> zur Verfügung, um gleichzeitig mehrere Dateien hochzuladen (siehe <a href="https://www.npmjs.com/package/multer">multer</a>). </p>
<p>Als <em>Response</em> wird die URL zurückgegeben, unter der das Bild heruntergeladen werden kann (<code>http://localhost:4000/download/${req.file.filename}</code>). </p>
<h3 id="routen-andern-und-einbinden">Routen ändern und einbinden<a class="headerlink" href="#routen-andern-und-einbinden" title="Permanent link">&para;</a></h3>
<p>In der ursprünglichen Implementierung hatten wir die Datei <code>routes.js</code> noch im Projektordner gehabt. Wir benennen diese in <code>posts.routes.js</code> um und schieben sie ebenfalls in den <code>routes</code>-Ordner. Beachten Sie, dass Sie dadurch in der <code>server.js</code> auch den Import auf <code>const routes = require('./routes/posts.routes');</code> ändern müssen.</p>
<p>Da wir nun aber auch die <code>upload</code>-Route einbinden, ändern wir gleich mehrere Sachen. Zunächst wird der ursprüngliche <code>routes</code> zu <code>postRoutes</code> und die generelle Route dafür wird <code>/posts</code>:</p>
<div class="tabbed-set" data-tabs="19:1"><input checked="checked" id="__tabbed_19_1" name="__tabbed_19" type="radio" /><label for="__tabbed_19_1">server.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">);</span>
<span class="hll"><span class="kd">const</span> <span class="nx">postsRoutes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/posts.routes&#39;</span><span class="p">);</span>
</span><span class="hll"><span class="kd">const</span> <span class="nx">uploadRoutes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/upload.routes&#39;</span><span class="p">);</span>
</span><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
  <span class="c1">// enable cors for all requests</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>
<span class="hll"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span> <span class="nx">postsRoutes</span><span class="p">);</span>
</span><span class="hll"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/img&#39;</span><span class="p">,</span> <span class="nx">uploadRoutes</span><span class="p">);</span>
</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`server running on http://localhost:</span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

  <span class="c1">// connect to mongoDB</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;connection error:&#39;</span><span class="p">));</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;connected to DB&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
<p>In der <code>posts.routes.js</code> kann nun aus den URLs der Endpunkte jeweils das <code>/posts</code> entfernt werden:</p>
<div class="tabbed-set" data-tabs="20:1"><input checked="checked" id="__tabbed_20_1" name="__tabbed_20" type="radio" /><label for="__tabbed_20_1">routes/posts.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">Post</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/posts&#39;</span><span class="p">);</span>

<span class="c1">// GET all posts</span>
<span class="hll"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span>    <span class="kd">const</span> <span class="nx">allPosts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">allPosts</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">allPosts</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// POST one post</span>
<span class="hll"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span>    <span class="kd">const</span> <span class="nx">newPost</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Post</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
        <span class="nx">location</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
        <span class="nx">image_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">image_id</span>
    <span class="p">})</span>
    <span class="k">await</span> <span class="nx">newPost</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newPost</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// POST one post via id</span>
<span class="hll"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span>    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// PATCH (update) one post</span>
<span class="hll"><span class="nx">router</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span>    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">})</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">image_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">image_id</span>
        <span class="p">}</span>

        <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">},</span> <span class="nx">post</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// DELETE one post via id</span>
<span class="hll"><span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span>    <span class="k">try</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">})</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">204</span><span class="p">).</span><span class="nx">send</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<h3 id="upload-mithilfe-von-postman">Upload mithilfe von Postman<a class="headerlink" href="#upload-mithilfe-von-postman" title="Permanent link">&para;</a></h3>
<p>Das Hochladen der Bilder kann nun bereits getestet werden. Starten Sie das Backend. Öffnen Sie Postman und geben Sie als URL <code>http://localhost:3000/upload</code> ein und wählen als Anfragemethode <code>POST</code>. Klicken Sie auf <code>Body</code> und markieren dann <code>form-data</code>:</p>
<p><img alt="upload" src="../files/244_file.png" /></p>
<p>Geben Sie unter <code>KEY</code> den Schlüssel <code>file</code> ein (das wird manchmal vergessen und dann bekommen Sie einen <code>multer</code>-Fehler <code>unexpected field</code>!) und wählen Sie aus dem Dropdown-Menü <code>File</code>. Unter <code>VALUE</code> erscheint der Button <code>Select Files</code>. Klicken Sie darauf und wählen ein <code>png</code>- oder ein <code>jpeg</code>-Bild (kann auch <code>.jpg</code> sein) aus, das Sie hochladen wollen. Klicken Sie dann auf <code>Send</code>. Es erscheint:</p>
<p><img alt="upload" src="../files/245_file.png" /></p>
<p>Ich habe in diesem Beispiel die Datei <code>fiw.jpg</code> hochgeladen. </p>
<p>Wenn Sie sich die MongoDB anschauen, dann finden Sie darin die beiden Collections <code>posts.files</code> und <code>posts.chunks</code>. In <code>posts.files</code> sind die Metadaten des hochgeladenen Bildes zu finden, z.B. </p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;627399fc6820d87a03418810&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">86584</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">261120</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-05T09:33:48.949Z&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1651743228869-jf-fiw.jpg&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;image/jpeg&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Die dazugehörige <code>_id</code> finden Sie auch in <code>posts.chunks</code> (können Sie sich in der <code>mongosh</code> mit <code>db.posts.chunks.find({ _id: "627399fc6820d87a03418810" })</code> anschauen). Darin ist das Bild im Binary-Format gespeichert. </p>
<h3 id="download-von-bildern">Download von Bildern<a class="headerlink" href="#download-von-bildern" title="Permanent link">&para;</a></h3>
<p>Für den Download der gespeicherten Bilder gehen wir ähnlich vor, wie beim Upload, benötigen dafür aber nicht mehr die <em>multer-Middleware</em>, dafür aber <code>gridfs-stream</code>. Wir erstellen im Ordner <code>routes</code> die Datei <code>download.routes.js</code> mit folgendem Inhalt:</p>
<div class="tabbed-set" data-tabs="21:1"><input checked="checked" id="__tabbed_21_1" name="__tabbed_21" type="radio" /><label for="__tabbed_21_1">routes/download.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">Grid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;gridfs-stream&quot;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">connect</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>

<span class="kd">let</span> <span class="nx">gfs</span><span class="p">,</span> <span class="nx">gfsb</span><span class="p">;</span>
<span class="nx">connect</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// initialize stream</span>
    <span class="nx">gfsb</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">GridFSBucket</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">bucketName</span><span class="o">:</span> <span class="s2">&quot;posts&quot;</span>
    <span class="p">});</span>

    <span class="nx">gfs</span> <span class="o">=</span> <span class="nx">Grid</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">mongo</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:filename&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">gfs</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span> <span class="nx">filename</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">filename</span> <span class="p">});</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
            <span class="nx">gfsb</span><span class="p">.</span><span class="nx">openDownloadStream</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="p">})</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;not found&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<p><a href="https://mongodb.github.io/node-mongodb-native/3.2/api/GridFSBucket.html">GridFSBucket</a> ist eine Klasse aus der <a href="https://mongodb.github.io/node-mongodb-native/3.2/api/index.html">Node.js-MongoDB-API</a>. Diese hätten wir auch schon für das Upload verwenden können (siehe z.B. <a href="https://edupeeth.com/all-courses/nodejs/mongodb-gridfs-bucket">hier</a>). </p>
<p>Da wir über den Dateinamen auf die Datei zugreifen wollen, benötigen wir zunächst die entsprechende <code>_id</code> der Datei in der <code>posts.chunks</code>-Collection. Dazu greifen wir mithilfe von <code>find()</code> auf die <code>posts.files</code>-Collection zu und ermitteln die <code>_id</code>. Die <code>find()</code>-Funktion gibt einen sogenannten <a href="https://docs.mongodb.com/drivers/node/current/fundamentals/crud/read-operations/cursor/">Cursor</a> auf das Array aller gefundenen Datensätze zurück. Mithilfe von <code>forEach()</code> durchlaufen wir dieses Array (enthält aber nur einen Datensatz) und ermitteln die <code>_id</code>. Mit der <code>openDownloadStream()</code>-Funktion der <code>GridFSBucket()</code>-Klasse öffnen wir den Download-Stream des Bildes und geben ihn als <em>response</em> <code>res</code> zurück. </p>
<p>Wir binden die <code>download</code>-Route nun noch in unsere <code>server.js</code> ein:</p>
<div class="tabbed-set" data-tabs="22:1"><input checked="checked" id="__tabbed_22_1" name="__tabbed_22" type="radio" /><label for="__tabbed_22_1">server.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">postsRoutes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/posts.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">uploadRoutes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/upload.routes&#39;</span><span class="p">);</span>
<span class="hll"><span class="kd">const</span> <span class="nx">downloadRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/download.routes&#39;</span><span class="p">);</span>
</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span> <span class="nx">postsRoutes</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/image&#39;</span><span class="p">,</span> <span class="nx">uploadRoutes</span><span class="p">);</span>
<span class="hll"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/download&#39;</span><span class="p">,</span> <span class="nx">downloadRoute</span><span class="p">);</span>
</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`server running on http://localhost:</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

  <span class="c1">// connect to mongoDB</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;connection error:&#39;</span><span class="p">));</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;connected to DB&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
<h3 id="download-mithilfe-von-postman">Download mithilfe von Postman<a class="headerlink" href="#download-mithilfe-von-postman" title="Permanent link">&para;</a></h3>
<p>Der Test des <code>GET http://localhost:3000/download/:filename</code>-Endpunktes ist einfach. Dazu verwenden wir einfach die URL, die durch den Upload als <em>Response</em>  zurückgegeben wurde (im obigen Beispiel also <code>"http://localhost:3000/download/1651743228869-jf-fiw.jpg"</code>):</p>
<p>Geben Sie in Postman also Ihre URL ein, wählen <code>GET</code> und klicken <code>Send</code>. Es erscheint das Bild:</p>
<p><img alt="upload" src="../files/246_file.png" /></p>
<p>Da es sich um die GET-Methode handelt, können Sie die URL <code>http://localhost:3000/download/1651743228869-jf-fiw.jpg</code> natürlich auch in den Browser eingeben und das Bild erscheint. </p>
<h3 id="download-als-base64-string">Download als base64-String<a class="headerlink" href="#download-als-base64-string" title="Permanent link">&para;</a></h3>
<p>Im oberen Beispiel wurde das Bild beim Download gestreamt. Wir betrachten nun die Möglichkeit, dass es als base64-String gesendet wird. Base64 ist ein Verfahren zur Kodierung von 8-Bit-Binärdaten (z.B. Bilder) in eine Zeichenfolge, die nur aus lesbaren, Codepage-unabhängigen ASCII-Zeichen besteht. Der String ist für ein Bild sehr lang. Er lässt sich aber leicht in eine Bildquelle umwandeln, damit das Bild dann im Frontend dargestellt werden kann. </p>
<p>Wir werden in der <code>download.routes.js</code> beide Möglichkeiten lassen (also sowohl den Stream als auch den base64-String). Deshalb passen wir die Routen der Endpunkte an. Die <code>/show/:filename</code>-Route ist für den Stream und die <code>/send/:filename</code>-Route für den <code>base64</code>-String. Wir präsentieren zunächst den Code und erläutern ihn dann. Die <code>download.routes.js</code> sieht dann so aus:</p>
<div class="tabbed-set" data-tabs="23:1"><input checked="checked" id="__tabbed_23_1" name="__tabbed_23" type="radio" /><label for="__tabbed_23_1">routes/download.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">Grid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;gridfs-stream&quot;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">multer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;multer&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">GridFsStorage</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;multer-gridfs-storage&#39;</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">MongoClient</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">connect</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">dbName</span> <span class="o">=</span> <span class="s2">&quot;posts&quot;</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">gfs</span><span class="p">,</span> <span class="nx">gfsb</span><span class="p">;</span>
<span class="nx">connect</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// initialize stream</span>
    <span class="nx">gfsb</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">GridFSBucket</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">bucketName</span><span class="o">:</span> <span class="s2">&quot;posts&quot;</span>
    <span class="p">});</span>

    <span class="nx">gfs</span> <span class="o">=</span> <span class="nx">Grid</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">mongo</span><span class="p">);</span>
    <span class="c1">// gfs.collection(&#39;file&#39;);</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/show/:filename&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">gfs</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span> <span class="nx">filename</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">filename</span> <span class="p">});</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
              <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">();</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;doc._id&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
            <span class="nx">gfsb</span><span class="p">.</span><span class="nx">openDownloadStream</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="p">})</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;not found&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/send/:filename&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

      <span class="kd">let</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">filename</span><span class="p">;</span>

      <span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
              <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Uploaded Error&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;MongoClient Connection error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">});</span>
          <span class="p">}</span>

          <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">dbName</span><span class="p">);</span>
          <span class="kd">const</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.files&#39;</span><span class="p">);</span>
          <span class="kd">const</span> <span class="nx">collectionChunks</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.chunks&#39;</span><span class="p">);</span>

          <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
                  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;File error&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Error finding file&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">});</span>
              <span class="p">}</span>

              <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">docs</span> <span class="o">||</span> <span class="nx">docs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mf">0</span><span class="p">){</span>
                  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Download Error&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;No file found&#39;</span><span class="p">});</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="c1">//Retrieving the chunks from the db</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;docs[0]._id&#39;</span><span class="p">,</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
                  <span class="nx">collectionChunks</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">files_id</span> <span class="o">:</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="nx">n</span><span class="o">:</span> <span class="mf">1</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">chunks</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
                          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Download Error&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Error retrieving chunks&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">errmsg</span><span class="p">});</span>
                      <span class="p">}</span>
                      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">chunks</span> <span class="o">||</span> <span class="nx">chunks</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mf">0</span><span class="p">){</span>
                          <span class="c1">//No data found</span>
                          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Download Error&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;No data found&#39;</span><span class="p">});</span>
                      <span class="p">}</span>
                      <span class="c1">//console.log(&#39;chunks&#39;, chunks)</span>
                      <span class="c1">//Append Chunks</span>
                      <span class="kd">let</span> <span class="nx">fileData</span> <span class="o">=</span> <span class="p">[];</span>
                      <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">chunk</span> <span class="k">of</span> <span class="nx">chunks</span><span class="p">){</span>
                          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;chunk&#39;</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">)</span>
                          <span class="c1">//This is in Binary JSON or BSON format, which is stored</span>
                          <span class="c1">//in fileData array in base64 endocoded string format</span>
                          <span class="nx">fileData</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
                      <span class="p">}</span>

                      <span class="c1">//Display the chunks using the data URI format</span>
                      <span class="kd">let</span> <span class="nx">finalFile</span> <span class="o">=</span> <span class="s1">&#39;data:&#39;</span> <span class="o">+</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">contentType</span> <span class="o">+</span> <span class="s1">&#39;;base64,&#39;</span> <span class="o">+</span> <span class="nx">fileData</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
                      <span class="c1">// console.log(&#39;finalFile&#39;, finalFile)</span>
                      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Image File&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Image loaded from MongoDB GridFS&#39;</span><span class="p">,</span> <span class="nx">imgurl</span><span class="o">:</span> <span class="nx">finalFile</span><span class="p">});</span>
                  <span class="p">})</span> <span class="c1">// toArray</span>
              <span class="p">}</span> <span class="c1">// else</span>
          <span class="p">})</span> <span class="c1">// toArray</span>
      <span class="p">})</span> <span class="c1">// connect</span>
  <span class="p">})</span> <span class="c1">// get</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<p>Die Funktion sieht auf den ersten Blick sehr umfangreich aus. Die meisten Zeilen sind jedoch für die Fehlerbehandlung. Wenn wir die Fehlerbahndlung (und die Kommentare und die Konsolenausgaben) entfernen, dann bleibt nur noch das übrig:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/send/:filename&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

        <span class="kd">let</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">filename</span><span class="p">;</span>

        <span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

            <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">dbName</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.files&#39;</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">collectionChunks</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.chunks&#39;</span><span class="p">);</span>

            <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

                    <span class="nx">collectionChunks</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">files_id</span> <span class="o">:</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="nx">n</span><span class="o">:</span> <span class="mf">1</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">chunks</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

                        <span class="kd">let</span> <span class="nx">fileData</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">chunk</span> <span class="k">of</span> <span class="nx">chunks</span><span class="p">){</span>
                            <span class="nx">fileData</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
                        <span class="p">}</span>

                        <span class="kd">let</span> <span class="nx">finalFile</span> <span class="o">=</span> <span class="s1">&#39;data:&#39;</span> <span class="o">+</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">contentType</span> <span class="o">+</span> <span class="s1">&#39;;base64,&#39;</span> <span class="o">+</span> <span class="nx">fileData</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Image File&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Image loaded from MongoDB GridFS&#39;</span><span class="p">,</span> <span class="nx">imgurl</span><span class="o">:</span> <span class="nx">finalFile</span><span class="p">});</span>
                    <span class="p">})</span> <span class="c1">// toArray</span>
            <span class="p">})</span> <span class="c1">// toArray</span>
        <span class="p">})</span> <span class="c1">// connect</span>
    <span class="p">})</span> <span class="c1">// get</span>
</code></pre></div>
</td></tr></table>
<p>Wir verwenden hier also direkt das <a href="https://www.npmjs.com/package/mongodb">mongodb</a>-Paket, das ist der MongoDB-Treiber für Node.js. Wir stellen eine Verbindung mit der Datenbank <code>posts</code> her (Zeile <code>5</code>) und erstellen uns drei Variablen, eine für die Datenbank, eine für die <code>posts.files</code>-Collection und eine für die <code>posts.chunks</code>-Collection (siehe <a href="https://www.mongodb.com/docs/drivers/node/v3.6/fundamentals/gridfs/">GridFS</a>). Dann suchen wir in der <code>posts.files</code>-Collection nach dem Dateinamen und ermitteln die zugehörige <code>_id</code> (speichern als <code>files_id</code>, erhalten wir aus <code>docs[0]._id</code> - siehe Zeile <code>13</code>). Nun suchen wir alle <code>chunks</code> mit dieser <code>files_id</code> und erhalten ein <code>chunks</code>-Array. Dieses Array enthält die <code>data</code> des jeweiligen <code>chunk</code>. Mithilfe der JavaScript-Funktion <code>toString('base64)</code> wandeln wir diese Daten in einen String um und speichern die String in das Array <code>fileData</code>. Dieses Array ist also ein Array aus Strings. Unter der Verwendung der <code>join('')</code>-Funktion von JavaScript werden alle diese String-Einträge zu einem String verbunden. Vor diesen String setzen wir noch <code>"data:image/jpeg;base64,"</code> (siehe z.B. <a href="https://elmah.io/tools/base64-image-encoder/">hier</a>). </p>
<p>Wenn wir nun ein Bild downloaden wollen, geben wir in Postman z.B. <code>http://localhost:3000/download/1652090780364-jf-htwbild4.jpg</code> ein und erhalten den sehr langen base64-String des Bildes. Die gleiche Funktionalität haben Sie auch, wenn Sie einen Online-Encoder verwenden, z.B. <a href="https://www.base64-image.de/">base64-image.de</a>.</p>
<h3 id="delete-von-bildern">Delete von Bildern<a class="headerlink" href="#delete-von-bildern" title="Permanent link">&para;</a></h3>
<p>Das Löschen der Bilder ist ganz ähnlich zum Download. Erstellen Sie die Datei <code>routes/delete.route.js</code>:</p>
<div class="tabbed-set" data-tabs="24:1"><input checked="checked" id="__tabbed_24_1" name="__tabbed_24" type="radio" /><label for="__tabbed_24_1">routes/delete.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">Grid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;gridfs-stream&quot;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">connect</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>

<span class="kd">let</span> <span class="nx">gfs</span><span class="p">;</span>
<span class="nx">connect</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">gfs</span> <span class="o">=</span> <span class="nx">Grid</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">mongo</span><span class="p">);</span>
    <span class="nx">gfs</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/:filename&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">gfs</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">).</span><span class="nx">deleteOne</span><span class="p">({</span> <span class="nx">filename</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">filename</span> <span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;deleted&quot;</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;An error occured.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<p>und binden diese in die <code>server.js</code> ein:</p>
<div class="tabbed-set" data-tabs="25:1"><input checked="checked" id="__tabbed_25_1" name="__tabbed_25" type="radio" /><label for="__tabbed_25_1">server.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">postsRoutes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/posts.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">uploadRoutes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/upload.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">downloadRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/download.routes&#39;</span><span class="p">);</span>
<span class="hll"><span class="kd">const</span> <span class="nx">deleteRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/delete.routes&#39;</span><span class="p">);</span>
</span><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span> <span class="nx">postsRoutes</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/image&#39;</span><span class="p">,</span> <span class="nx">uploadRoutes</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/download&#39;</span><span class="p">,</span> <span class="nx">downloadRoute</span><span class="p">);</span>
<span class="hll"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/delete&#39;</span><span class="p">,</span> <span class="nx">deleteRoute</span><span class="p">);</span>
</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`server running on http://localhost:</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// connect to mongoDB</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;connection error:&#39;</span><span class="p">));</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;connected to DB&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
<h3 id="delete-mithilfe-von-postman">Delete mithilfe von Postman<a class="headerlink" href="#delete-mithilfe-von-postman" title="Permanent link">&para;</a></h3>
<p>Zum Testen verwenden Sie den gleichen Dateinamen wie beim Download und wählen als Anfragemethode <code>DELETE</code>. </p>
<h2 id="zusammenfuhren-der-funktionalitaten">Zusammenführen der Funktionalitäten<a class="headerlink" href="#zusammenfuhren-der-funktionalitaten" title="Permanent link">&para;</a></h2>
<p>Wir haben nun recht viele Routen und Endpunkte in unserem Backend. Wir wollen aber gerne, dass es nur die fünf genannten Endpunkte gibt:</p>
<table>
<thead>
<tr>
<th> Methode</th>
<th> URL</th>
<th> Bedeutung</th>
</tr>
</thead>
<tbody>
<tr>
<td> GET</td>
<td> /posts</td>
<td> hole alle Datensätze</td>
</tr>
<tr>
<td> GET</td>
<td> /posts/11</td>
<td>hole den Datensatz mit der id=11</td>
</tr>
<tr>
<td> POST</td>
<td> /posts</td>
<td> füge einen neuen Datensatz hinzu</td>
</tr>
<tr>
<td> PUT</td>
<td> /posts/11</td>
<td> ändere den Datensatz mit der id=11</td>
</tr>
<tr>
<td> DELETE</td>
<td> /posts/11</td>
<td> lösche den Datensatz mit der id=11</td>
</tr>
</tbody>
</table>
<p>Das bedeutet, wir binden den Upload und Download von Bildern nun in unsere <code>posts</code>-Routen ein. Die Funktionen werden dabei "etwas" umfangreicher. </p>
<h3 id="zum-verstandnis">Zum Verständnis<a class="headerlink" href="#zum-verstandnis" title="Permanent link">&para;</a></h3>
<p>Wir verwenden <a href="https://www.npmjs.com/package/multer">Multer</a> und <a href="https://www.npmjs.com/package/multer-gridfs-storage">GridFs storage</a>. Multer ist eine <em>Middleware</em> für Node.js, um Daten im <code>multipart/form-data</code>-Format zu verwalten. Die grundsätzliche Idee ist, dass im <em>Request</em> nicht nur ein <code>body</code>, sondern auch eine <code>file</code>-Eigenschaft enthalten ist (neben dem <code>header</code>). Multer verwendet einen <code>storage</code>, um Bilder (oder andere Dateien) zu speichern. Einen solchen <code>storage</code> bietet <code>GridFs storage</code>. Dieser kann sogar Dateien größer als 16 MB speichern und die Idee dabei ist, dass die Datei in zwei Collections gespeichert wird, in der <code>files</code>-Collection, welche die (Meta-)Informationen der Datei speichert und der <code>chunks</code>-Collection, die die eigentliche Datei (als Binärdaten) speichert. Eine Datei kann dabei in mehrere <code>chunks</code> unterteilt werden. Die folgende Abbildung zeigt das Prinzip von <code>GridFS</code>:</p>
<p><img alt="upload" src="../files/251_file.png" /></p>
<p>Für unser Datenmodell sieht die Auteilung der Daten somit wie folgt aus:</p>
<ul>
<li>
<p>in der <code>posts</code>-Collection speichern wir</p>
<ul>
<li>die <code>_id</code> des Posts,</li>
<li>den <code>title</code> eines Posts,</li>
<li>die <code>location</code> und </li>
<li>die <code>image_id</code>. Die <code>image_id</code> enthält den Dateinamen <code>filename</code> des Bildes.</li>
</ul>
</li>
<li>
<p>in der <code>posts.files</code>-Collection speichern wir (GridFs)</p>
<ul>
<li>die <code>_id</code> der Datei,</li>
<li>die <code>length</code> der Datei,</li>
<li>die <code>chunkSize</code>, </li>
<li>das <code>uploadDate</code>, </li>
<li>den <code>filename</code> (siehe in <code>posts</code> die <code>image_id</code>) und </li>
<li>den <code>contenType</code> (z.B. <code>image/jpeg</code>)</li>
</ul>
</li>
<li>
<p>in der <code>posts.chunks</code>-Collection speichern wir (GridFs)</p>
<ul>
<li>die <code>_id</code> des Chunks,</li>
<li>die <code>files_id</code> (diese entspricht der <code>_id</code> der Datei in der <code>posts.files</code>-Collection),</li>
<li>ein <code>n</code> (fortlaufende Nummerierung der Chunks einer Datei beginnend mit <code>0</code>),</li>
<li>die <code>data</code> der Datei (in diesem Chunk)</li>
</ul>
</li>
</ul>
<p>Chunks kann es zu einer Datei mehrere geben. Alle <code>data</code> aller Chunks einer Datei bilden zusammen die Datei als Binär- (bzw. base64-) Daten. Die folgende Abbildung zeigt unser Datenmodell in der Datenbank <code>posts</code>:</p>
<p><img alt="upload" src="../files/251_file.png" /></p>
<p>Um z.B. einen Datensatz (einen Post) anzulegen, speichern wir also die zugehörigen Daten in der <code>posts</code>-Collection (inkl. dem <code>filename</code> der Datei), speichern die Meta-Informationen der Datei in der <code>posts.files</code>-Collection und die zugehörigen Binärdaten der Datei in <code>posts.chunks</code>. </p>
<h3 id="post-kompletter-datensatz">POST - kompletter Datensatz<a class="headerlink" href="#post-kompletter-datensatz" title="Permanent link">&para;</a></h3>
<p>Die <code>POST</code>-Funktion für einen Datensatz ist nicht viel umfangreicher als zuvor:</p>
<div class="tabbed-set" data-tabs="26:1"><input checked="checked" id="__tabbed_26_1" name="__tabbed_26" type="radio" /><label for="__tabbed_26_1">aus routes/posts.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="c1">// POST one post</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">upload</span><span class="p">.</span><span class="nx">single</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// req.file is the `file` file</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;no file selected&quot;</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;req.body&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">newPost</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Post</span><span class="p">({</span>
            <span class="nx">title</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
            <span class="nx">location</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
            <span class="nx">image_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">filename</span>
        <span class="p">})</span>
        <span class="k">await</span> <span class="nx">newPost</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newPost</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre></div>
</td></tr></table>
<p>Wichtig ist, dass <code>posts.routes.js</code> nun auch die <code>upload.js</code> einbindet:</p>
<div class="tabbed-set" data-tabs="27:1"><input checked="checked" id="__tabbed_27_1" name="__tabbed_27" type="radio" /><label for="__tabbed_27_1">aus routes/posts.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middleware/upload&#39;</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>Beachten Sie, dass die Daten nun nicht mehr als JSON übergeben werden, sondern als <code>form-data</code>. Der Test mithilfe von Postman sieht deshalb nun so aus:</p>
<p><img alt="posts" src="../files/247_file.png" /> </p>
<p>Als Response bekommen Sie aber wieder ein JSON zurück, z.B.:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HTW Gebäude C&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Campus Wilhelminenhof&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1652166642127-jf-htwbild5.jpg&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;627a0ff2305433d805b6b437&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Das Bild ist nun in der Collection <code>posts</code> einerseits in <code>posts.files</code> mit den Daten</p>
<p><img alt="posts" src="../files/248_file.png" /> </p>
<p>und in <code>posts.chunks</code> mit den Daten</p>
<p><img alt="posts" src="../files/249_file.png" /> </p>
<p>gespeichert. Beachten Sie, dass das Bild so klein ist, dass es in nur einem <code>chunk</code> gespeichert werden kann. Größere Dateien werden in mehrer <code>chunks</code> aufgeteilt. Alle diese <code>chunks</code>, die zu einem Bild gehören, haben dann dieselbe <code>files_id</code> (aber fortlaufende <code>_id</code>s).</p>
<p>In der <code>posts</code>-Collection sieht der Datensatz dann wie folgt aus:</p>
<p><img alt="posts" src="../files/250_file.png" /> </p>
<h3 id="get-ein-kompletter-datensatz">GET - ein kompletter Datensatz<a class="headerlink" href="#get-ein-kompletter-datensatz" title="Permanent link">&para;</a></h3>
<p>Jetzt den kompletten Datensatz mit einer bestimmten <code>_id</code> zu laden, ist etwas aufwendiger:</p>
<ol>
<li>Wir laden zunächst aus der <code>posts</code>-Collection den Datensatz mit der <code>_id</code>. </li>
<li>Aus diesem Datensatz lesen wir die <code>image_id</code> aus. Das ist der <code>filename</code> mit dem wir in der <code>posts.files</code>-Collection suchen. </li>
<li>Aus der <code>posts.files</code>-Collection lesen wir den Datensatz mit dem <code>filename</code> aus und identifizieren dessen <code>_id</code>. </li>
<li>Nach dieser <code>_id</code> suchen wir unter <code>files_id</code> in der <code>posts.chunks</code>-Collection und lesen alle zugehörigen <code>chunks</code> aus. </li>
</ol>
<p>Dazu schreiben wir uns zunächst eine Funktion <code>getOnePost(id)</code>, die ein <code>Promise</code> zurückgibt.</p>
<div class="tabbed-set" data-tabs="28:1"><input checked="checked" id="__tabbed_28_1" name="__tabbed_28" type="radio" /><label for="__tabbed_28_1">aus routes/posts.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">connect</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">collectionFiles</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.files&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">collectionChunks</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.chunks&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">getOnePost</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="ow">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="k">async</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">id</span> <span class="p">});</span>
            <span class="c1">// console.log(&#39;post.image_id&#39;, post.image_id);</span>
            <span class="kd">let</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span><span class="p">;</span>

            <span class="nx">collectionFiles</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="k">async</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="c1">// console.log(&#39;docs&#39;, docs)</span>

                <span class="nx">collectionChunks</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">files_id</span> <span class="o">:</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="nx">n</span><span class="o">:</span> <span class="mf">1</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">chunks</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>


                    <span class="kd">const</span> <span class="nx">fileData</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">chunk</span> <span class="k">of</span> <span class="nx">chunks</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// console.log(&#39;chunk._id&#39;, chunk._id)</span>
                        <span class="nx">fileData</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
                    <span class="p">}</span>

                    <span class="kd">let</span> <span class="nx">base64file</span> <span class="o">=</span> <span class="s1">&#39;data:&#39;</span> <span class="o">+</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">contentType</span> <span class="o">+</span> <span class="s1">&#39;;base64,&#39;</span> <span class="o">+</span> <span class="nx">fileData</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
                    <span class="kd">let</span> <span class="nx">getPost</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Post</span><span class="p">({</span>
                        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
                        <span class="s2">&quot;location&quot;</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> 
                        <span class="s2">&quot;image_id&quot;</span><span class="o">:</span> <span class="nx">base64file</span>
                    <span class="p">});</span>
                    <span class="c1">//console.log(&#39;getPost&#39;, getPost)</span>
                    <span class="nx">resolve</span><span class="p">(</span><span class="nx">getPost</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="p">})</span> <span class="c1">// toArray find filename</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nx">reject</span><span class="p">(</span><span class="ow">new</span> <span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Post does not exist!&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Die Konsolenausgaben können natürlich auch alle entfernt werden, aber es lohnt sich vielleicht auch zu sehen, was an den einzelnen Stellen passiert. In Zeile <code>30</code> erfolgt der Zugriff auf die <code>posts</code>-Collection und es wird der Datensatz mit der <code>_id</code> ermittelt, welche als Parameter der URL übergeben wurde. Aus dem Ergebnis <code>post</code> wird dann der Dateiname des Bildes in Zeile <code>32</code> mithilfe von <code>post.image_id</code> ermittelt. </p>
<p>In der <code>post.files</code>-Collection wird in Zeile <code>34</code> nach dem Datensatz mit dem entsprechenden <code>filename</code> gesucht. Die <code>_id</code> dieses Datensatzes ist der Wert von <code>files_id</code> in der Collection <code>posts.chunks</code>. Nach all diesen Einträgen wird in Zeile <code>37</code> gesucht. Aus allen <code>chunks</code> wird dann der <code>base64</code>-String erzeugt und dem <code>Post</code>-Objekt übergeben, welches als <code>resolve</code> der <code>Promise</code> zurückgeschickt wird. </p>
<p>Diese Funktion können wir nun für unseren <code>get('/:id')</code>-Endpunkt verwenden. Die Funktion sieht dann wie folgt aus:</p>
<div class="tabbed-set" data-tabs="29:1"><input checked="checked" id="__tabbed_29_1" name="__tabbed_29" type="radio" /><label for="__tabbed_29_1">aus routes/posts.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// GET one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">getOnePost</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span>
        <span class="p">});</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
<p>Wir übergeben der <code>getOnePost()</code>-Funktion die als Parameter übergebene <code>id</code> und senden den <code>resolve</code>-Wert der <code>Promise</code> als Response zurück. </p>
<h3 id="get-alle-datensatze">GET - alle Datensätze<a class="headerlink" href="#get-alle-datensatze" title="Permanent link">&para;</a></h3>
<p>Der Ansatz, um alle Datensätze aus der MongoDB zu lesen, ist der gleiche, wie für einen Datensatz. Wir ermitteln sukzessive die <code>_id</code> alle Datensätze in der <code>posts</code>-Collection. Dazu schreiben wir uns eine Funktion <code>getAllPosts()</code>. In dieser laden wir zunächst alle <code>posts</code> und rufen dann für jeden einzelnen die <code>getOnePost(id</code>-Funktion auf:</p>
<div class="tabbed-set" data-tabs="30:1"><input checked="checked" id="__tabbed_30_1" name="__tabbed_30" type="radio" /><label for="__tabbed_30_1">aus routes/posts.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">getAllPosts</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="ow">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="k">async</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">sendAllPosts</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="kd">const</span> <span class="nx">allPosts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">const</span> <span class="nx">post</span> <span class="k">of</span> <span class="nx">allPosts</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">)</span>
                <span class="kd">const</span> <span class="nx">onePost</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getOnePost</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
                <span class="nx">sendAllPosts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">onePost</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;sendAllPosts&#39;</span><span class="p">,</span> <span class="nx">sendAllPosts</span><span class="p">)</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">sendAllPosts</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                <span class="nx">reject</span><span class="p">(</span><span class="ow">new</span> <span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Posts do not exist!&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Die Verwendung dieser Funktion ist wie oben:</p>
<div class="tabbed-set" data-tabs="31:1"><input checked="checked" id="__tabbed_31_1" name="__tabbed_31" type="radio" /><label for="__tabbed_31_1">aus routes/posts.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// GET all posts</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

    <span class="nx">getAllPosts</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">posts</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">posts</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post do not exist!&quot;</span>
        <span class="p">});</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
<h3 id="delete-einen-datensatz">DELETE - einen Datensatz<a class="headerlink" href="#delete-einen-datensatz" title="Permanent link">&para;</a></h3>
<p>Wird ein Post gelöscht, müssen wir auch dafür sorgen, dass das zugehörige Bild aus der <code>posts.files</code> und der <code>posts.chunks</code> gelöscht wird. Das Löschen ist also dreistufig:</p>
<div class="tabbed-set" data-tabs="32:1"><input checked="checked" id="__tabbed_32_1" name="__tabbed_32" type="radio" /><label for="__tabbed_32_1">aus routes/posts.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// DELETE one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">})</span>
        <span class="kd">let</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span><span class="p">;</span>
        <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
        <span class="k">await</span> <span class="nx">collectionFiles</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="k">async</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">await</span> <span class="nx">collectionChunks</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">({</span><span class="nx">files_id</span> <span class="o">:</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">});</span>
        <span class="p">})</span>
        <span class="k">await</span> <span class="nx">collectionFiles</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">204</span><span class="p">).</span><span class="nx">send</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
<h3 id="zusammenfassung-code-des-backends">Zusammenfassung - Code des Backends<a class="headerlink" href="#zusammenfassung-code-des-backends" title="Permanent link">&para;</a></h3>
<p>Hier nochmal alle wichtigen Dateien unseres Backends:</p>
<div class="tabbed-set" data-tabs="33:1"><input checked="checked" id="__tabbed_33_1" name="__tabbed_33" type="radio" /><label for="__tabbed_33_1">server.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">postsRoutes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/posts.routes&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span> <span class="nx">postsRoutes</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`server running on http://localhost:</span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="cm">/* die folgende Verbindung brauchen wir gar nicht, wird jeweils bei Bedarf erzeugt (mongoose) */</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;connected to BD&#39;</span><span class="p">)</span>
<span class="p">).</span><span class="k">catch</span><span class="p">(</span>
    <span class="nx">err</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s1">&#39;conncetion error&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<div class="tabbed-set" data-tabs="34:1"><input checked="checked" id="__tabbed_34_1" name="__tabbed_34" type="radio" /><label for="__tabbed_34_1">middleware/upload.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">multer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;multer&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">GridFsStorage</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;multer-gridfs-storage&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">GridFsStorage</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span>
    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="nx">file</span><span class="o">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span> <span class="s2">&quot;image/jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">];</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">mimetype</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mf">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">-jf-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">bucketName</span><span class="o">:</span> <span class="s1">&#39;posts&#39;</span><span class="p">,</span>
            <span class="nx">filename</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">-jf-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> 
            <span class="nx">request</span><span class="o">:</span> <span class="nx">req</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nx">storage</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">multer</span><span class="p">({</span> <span class="nx">storage</span> <span class="p">});</span>
</code></pre></div>
</td></tr></table>
<div class="tabbed-set" data-tabs="35:1"><input checked="checked" id="__tabbed_35_1" name="__tabbed_35" type="radio" /><label for="__tabbed_35_1">routes/posts.routes.js</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">Post</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/posts&#39;</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middleware/upload&#39;</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">)</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">()</span>

<span class="cm">/* ----------------- POST ---------------------------- */</span>

<span class="c1">// POST one post</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">upload</span><span class="p">.</span><span class="nx">single</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;no file selected&quot;</span>
        <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">newPost</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Post</span><span class="p">({</span>
            <span class="nx">title</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
            <span class="nx">location</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
            <span class="nx">image_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">filename</span>
        <span class="p">})</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;newPost&#39;</span><span class="p">,</span> <span class="nx">newPost</span><span class="p">)</span>
        <span class="k">await</span> <span class="nx">newPost</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newPost</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="cm">/* ----------------- GET ---------------------------- */</span>

<span class="kd">const</span> <span class="nx">connect</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">useUnifiedTopology</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">collectionFiles</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.files&#39;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">collectionChunks</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.chunks&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">getOnePost</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="ow">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="k">async</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">id</span> <span class="p">});</span>
            <span class="kd">let</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span><span class="p">;</span>

            <span class="nx">collectionFiles</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="k">async</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

                <span class="c1">// sort({n: 1}) --&gt; die chunks nach Eigenschaft n aufsteigend sortieren</span>
                <span class="nx">collectionChunks</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">files_id</span> <span class="o">:</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="nx">n</span><span class="o">:</span> <span class="mf">1</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">chunks</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

                    <span class="kd">const</span> <span class="nx">fileData</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">chunk</span> <span class="k">of</span> <span class="nx">chunks</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// console.log(&#39;chunk._id&#39;, chunk._id)</span>
                        <span class="nx">fileData</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
                    <span class="p">}</span>

                    <span class="kd">let</span> <span class="nx">base64file</span> <span class="o">=</span> <span class="s1">&#39;data:&#39;</span> <span class="o">+</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">contentType</span> <span class="o">+</span> <span class="s1">&#39;;base64,&#39;</span> <span class="o">+</span> <span class="nx">fileData</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
                    <span class="kd">let</span> <span class="nx">getPost</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Post</span><span class="p">({</span>
                        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
                        <span class="s2">&quot;location&quot;</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> 
                        <span class="s2">&quot;image_id&quot;</span><span class="o">:</span> <span class="nx">base64file</span>
                    <span class="p">});</span>

                    <span class="nx">resolve</span><span class="p">(</span><span class="nx">getPost</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="p">})</span> <span class="c1">// toArray find filename</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nx">reject</span><span class="p">(</span><span class="ow">new</span> <span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Post does not exist!&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getAllPosts</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="ow">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="k">async</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">sendAllPosts</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="kd">const</span> <span class="nx">allPosts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">const</span> <span class="nx">post</span> <span class="k">of</span> <span class="nx">allPosts</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">)</span>
                <span class="kd">const</span> <span class="nx">onePost</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getOnePost</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
                <span class="nx">sendAllPosts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">onePost</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;sendAllPosts&#39;</span><span class="p">,</span> <span class="nx">sendAllPosts</span><span class="p">)</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">sendAllPosts</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                <span class="nx">reject</span><span class="p">(</span><span class="ow">new</span> <span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Posts do not exist!&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// GET one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">getOnePost</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span>
        <span class="p">});</span>
    <span class="p">})</span>
<span class="p">});</span>

<span class="c1">// GET all posts</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

    <span class="nx">getAllPosts</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">posts</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">posts</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post do not exist!&quot;</span>
        <span class="p">});</span>
    <span class="p">})</span>
<span class="p">});</span>


<span class="cm">/* ----------------- DELETE ---------------------------- */</span>

<span class="c1">// DELETE one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">})</span>
        <span class="kd">let</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span><span class="p">;</span>
        <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
        <span class="k">await</span> <span class="nx">collectionFiles</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span> <span class="k">async</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">await</span> <span class="nx">collectionChunks</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">({</span><span class="nx">files_id</span> <span class="o">:</span> <span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">});</span>
        <span class="p">})</span>
        <span class="k">await</span> <span class="nx">collectionFiles</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">204</span><span class="p">).</span><span class="nx">send</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Post does not exist!&quot;</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<div class="tabbed-set" data-tabs="36:1"><input checked="checked" id="__tabbed_36_1" name="__tabbed_36" type="radio" /><label for="__tabbed_36_1">.env</label><div class="tabbed-content"></div>
</div>
<div class="highlight"><pre><span></span><code>DB_CONNECTION = mongodb://localhost:27017/posts 
PORT = 3000
</code></pre></div>
<h3 id="zusammenfassung-die-mongodb-posts">Zusammenfassung - die MongoDB <code>posts</code><a class="headerlink" href="#zusammenfassung-die-mongodb-posts" title="Permanent link">&para;</a></h3>
<p>Hier einige Datensätze für die Datenbank <code>posts</code>:</p>
<div class="tabbed-set" data-tabs="37:1"><input checked="checked" id="__tabbed_37_1" name="__tabbed_37" type="radio" /><label for="__tabbed_37_1">Collection posts</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278e79c6664ce70884dd0b0&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;WH Eingang&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652090780364-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a0ff2305433d805b6b437&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;HTW Gebäude C&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652166642127-jf-htwbild5.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7cad8ae16b1ba5f62f76&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Mensastrand&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof Mensa&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194477890-jf-htwbild1.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7cdf8ae16b1ba5f62f80&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Wiese Campus WH&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof Gebäude C&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194527176-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d0b8ae16b1ba5f62f84&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Berühmt wegen FIW&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof Gebäude C&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194571822-jf-htwbild3.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d398ae16b1ba5f62f8b&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Haupttor HTW&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Wilhelminenhofstraße HTW&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194617191-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d608ae16b1ba5f62f8f&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Gebäude C&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;HTW Berlin&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194656102-jf-htwbild5.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<div class="tabbed-set" data-tabs="38:1"><input checked="checked" id="__tabbed_38_1" name="__tabbed_38" type="radio" /><label for="__tabbed_38_1">Collection posts.files</label><div class="tabbed-content"></div>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278d47e96a41858d66f1621&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">984341</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T08:44:46.239Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652085886102-jf-htwbild1.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278d5f902370f2c675993e9&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1601800</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T08:51:05.478Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652086265414-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278db738d2b5bc5968f453e&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1601800</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T09:14:27.957Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652087667872-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278db918d2b5bc5968f4546&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1601800</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T09:14:57.113Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652087697071-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278dd057c648b9e8e3bbb74&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">117492</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T09:21:09.873Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652088069823-jf-htwbild3.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278e74458477bf1223fa286&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1038579</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T10:04:53.07Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652090692995-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278e79c6664ce70884dd0ab&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1038579</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T10:06:20.437Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652090780364-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a0ff2305433d805b6b435&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">25449</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T07:10:42.191Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652166642127-jf-htwbild5.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7cad8ae16b1ba5f62f71&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">984341</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:54:37.954Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194477890-jf-htwbild1.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7cdf8ae16b1ba5f62f78&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1601800</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:55:27.23Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194527176-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d0b8ae16b1ba5f62f82&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">117492</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:56:11.84Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194571822-jf-htwbild3.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d398ae16b1ba5f62f86&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1038579</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:56:57.214Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194617191-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d608ae16b1ba5f62f8d&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">25449</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:57:36.11Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194656102-jf-htwbild5.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<p>Die Collection <code>posts.chunks</code> ist sehr groß, deshalb <a href="../files/posts_chunks.json">hier zum Download</a>.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../caching/" class="md-footer__link md-footer__link--prev" aria-label="Zurück: Caching" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Zurück
              </span>
              Caching
            </div>
          </div>
        </a>
      
      
        
        <a href="../indexeddb/" class="md-footer__link md-footer__link--next" aria-label="Weiter: IndexedDB" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Weiter
              </span>
              IndexedDB
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2022 Jörn Freiheit
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["instant", "tabs"], "translations": {"clipboard.copy": "In Zwischenablage kopieren", "clipboard.copied": "In Zwischenablage kopiert", "search.config.lang": "de", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Suche", "search.result.placeholder": "Suchbegriff eingeben", "search.result.none": "Keine Suchergebnisse", "search.result.one": "1 Suchergebnis", "search.result.other": "# Suchergebnisse", "search.result.more.one": "1 weiteres Suchergebnis auf dieser Seite", "search.result.more.other": "# weitere Suchergebnisse auf dieser Seite", "search.result.term.missing": "Es fehlt", "select.version.title": "Version ausw\u00e4hlen"}, "search": "../assets/javascripts/workers/search.409db549.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.756773cc.min.js"></script>
      
    
  </body>
</html>