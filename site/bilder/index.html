
<!doctype html>
<html lang="de" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Lehrmaterial, Übungen, Aufgaben und Hilfen für Aktuelle Trends der IKT">
      
      
        <meta name="author" content="Jörn Freiheit">
      
      
        <link rel="canonical" href="http://freiheit.f4.htw-berlin.de/ikt/bilder/">
      
      
        <link rel="prev" href="../indexeddb/">
      
      
        <link rel="next" href="../kamera/">
      
      <link rel="icon" href="../img/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.8">
    
    
      
        <title>Bilder speichern - Progressive Web Apps</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="grey" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#backend-erweiterung-um-das-speichern-von-bildern" class="md-skip">
          Zum Inhalt
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Kopfzeile">
    <a href=".." title="Progressive Web Apps" class="md-header__button md-logo" aria-label="Progressive Web Apps" data-md-component="logo">
      
  <img src="../img/fiw.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Progressive Web Apps
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Bilder speichern
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Suche" placeholder="Suche" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Suche">
        
        <button type="reset" class="md-search__icon md-icon" title="Zurücksetzen" aria-label="Zurücksetzen" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Suche wird initialisiert
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jfreiheit/ikt_2023" title="Zum Repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    webtech
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Progressive Web Apps" class="md-nav__button md-logo" aria-label="Progressive Web Apps" data-md-component="logo">
      
  <img src="../img/fiw.jpg" alt="logo">

    </a>
    Progressive Web Apps
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jfreiheit/ikt_2023" title="Zum Repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    webtech
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../einfuehrung/" class="md-nav__link">
        Einführung
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../grundgeruest/" class="md-nav__link">
        Grundgerüst
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../manifest/" class="md-nav__link">
        Manifest
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../serviceworker/" class="md-nav__link">
        Service worker
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../promises/" class="md-nav__link">
        Promises & Fetch-API
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../caching/" class="md-nav__link">
        Caching
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../backend/" class="md-nav__link">
        Backend
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../indexeddb/" class="md-nav__link">
        IndexedDB
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Bilder speichern
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Bilder speichern
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Inhaltsverzeichnis">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Inhaltsverzeichnis
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#upload-von-bildern" class="md-nav__link">
    Upload von Bildern
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upload-mithilfe-von-postman" class="md-nav__link">
    Upload mithilfe von Postman
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#download-von-bildern" class="md-nav__link">
    Download von Bildern
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#download-mithilfe-von-postman" class="md-nav__link">
    Download mithilfe von Postman
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delete-von-bildern" class="md-nav__link">
    Delete von Bildern
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delete-mithilfe-von-postman" class="md-nav__link">
    Delete mithilfe von Postman
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zusammenfuhren-der-funktionalitaten" class="md-nav__link">
    Zusammenführen der Funktionalitäten
  </a>
  
    <nav class="md-nav" aria-label="Zusammenführen der Funktionalitäten">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zum-verstandnis" class="md-nav__link">
    Zum Verständnis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-kompletter-datensatz" class="md-nav__link">
    POST - kompletter Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-ein-kompletter-datensatz" class="md-nav__link">
    GET - ein kompletter Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-alle-datensatze" class="md-nav__link">
    GET - alle Datensätze
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-einen-datensatz" class="md-nav__link">
    DELETE - einen Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zusammenfassung-code-des-backends" class="md-nav__link">
    Zusammenfassung - Code des Backends
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zusammenfassung-die-mongodb-posts" class="md-nav__link">
    Zusammenfassung - die MongoDB posts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../kamera/" class="md-nav__link">
        Kamera
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../geolocation/" class="md-nav__link">
        Geolocation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../backgroundsync/" class="md-nav__link">
        Hintergrundsynchronisation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../pushnotes/" class="md-nav__link">
        Push Notifications
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../uebungen/" class="md-nav__link">
        Übungen
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tools/" class="md-nav__link">
        Tools
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Inhaltsverzeichnis">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Inhaltsverzeichnis
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#upload-von-bildern" class="md-nav__link">
    Upload von Bildern
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upload-mithilfe-von-postman" class="md-nav__link">
    Upload mithilfe von Postman
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#download-von-bildern" class="md-nav__link">
    Download von Bildern
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#download-mithilfe-von-postman" class="md-nav__link">
    Download mithilfe von Postman
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delete-von-bildern" class="md-nav__link">
    Delete von Bildern
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delete-mithilfe-von-postman" class="md-nav__link">
    Delete mithilfe von Postman
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zusammenfuhren-der-funktionalitaten" class="md-nav__link">
    Zusammenführen der Funktionalitäten
  </a>
  
    <nav class="md-nav" aria-label="Zusammenführen der Funktionalitäten">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zum-verstandnis" class="md-nav__link">
    Zum Verständnis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-kompletter-datensatz" class="md-nav__link">
    POST - kompletter Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-ein-kompletter-datensatz" class="md-nav__link">
    GET - ein kompletter Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-alle-datensatze" class="md-nav__link">
    GET - alle Datensätze
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-einen-datensatz" class="md-nav__link">
    DELETE - einen Datensatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zusammenfassung-code-des-backends" class="md-nav__link">
    Zusammenfassung - Code des Backends
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zusammenfassung-die-mongodb-posts" class="md-nav__link">
    Zusammenfassung - die MongoDB posts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/jfreiheit/ikt_2023/edit/master/docs/bilder.md" title="Seite editieren" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/jfreiheit/ikt_2023/raw/master/docs/bilder.md" title="Quellcode der Seite anzeigen" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.15 8.15 0 0 1-1.23-2Z"/></svg>
    </a>
  


<h1 id="backend-erweiterung-um-das-speichern-von-bildern">Backend-Erweiterung um das Speichern von Bildern<a class="headerlink" href="#backend-erweiterung-um-das-speichern-von-bildern" title="Permanent link">&para;</a></h1>
<p>Bis jetzt haben wir nur Daten im JSON-Format zwischen Frontend und Backend ausgetauscht und auch nur solche Daten in der MongoDB gespeichert. Bilder (und auch andere Dateien) sind <a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData/Using_FormData_Objects">FormData-Objects</a> im <code>multipart/form-data</code>-Format. Zur Behandlung solcher Daten verwenden wir ein <em>Middleware</em> für unser Backend, namens <a href="https://www.npmjs.com/package/multer">Multer</a>. </p>
<div class="admonition hint">
<p class="admonition-title">Hint<p>Wenn Sie nur am Code für unser Backend interessiert sind, dann können Sie auch direkt zu <a href="./#zusammenfuhren-der-funktionalitaten">Zusammenführen der Funktionalitäten</a> springen. Im Folgenden werden die Entstehung aber näher erläutert und verschiedene Varianten diskutiert. </p>
</p>
</div>
<p>MongoDB speichert Daten bis zu einer Größe von <code>16Mb</code> im Binärformat. Um auch größere Dateien (Bilder, Videos, pdf, ...) speichern zu können, werden die Dateien in <em>chunks</em> zerlegt und können dann aus diesen Stücken wieder zusammengesetzt werden. Dafür gibt es in der MongoDB eine <a href="https://docs.mongodb.com/manual/core/gridfs/">GridFS</a>-Spezifikation. Das <a href="https://www.mongodb.com/docs/drivers/node/current/">MongoDB-Paket</a> (also der MongoDB-Node.js-Treiber bringt bereits eine <a href="http://mongodb.github.io/node-mongodb-native/3.0/tutorials/gridfs/streaming/#the-gridfs-api">GridFS-API</a> mit. Für die Zusammenarbeit von <a href="https://www.npmjs.com/package/multer">Multer</a> und <a href="https://docs.mongodb.com/manual/core/gridfs/">GridFS</a> bietet sich <a href="https://www.npmjs.com/package/multer-gridfs-storage">Multer-GridFS-Storage</a> an. </p>
<p>Wir installieren <a href="https://www.npmjs.com/package/multer">Multer</a> und <a href="https://www.npmjs.com/package/multer-gridfs-storage">Multer-GridFS-Storage</a> im Backend-Projekt und zeigen im Folgenden deren Verwendung:</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>multer<span class="w"> </span>multer-gridfs-storage
</code></pre></div>
<p>Leider ist die Version <code>5.0.2</code> von <code>multer-gridfs-storage</code> <a href="https://stackoverflow.com/questions/74167128/dependency-problem-using-multer-and-multer-gridfs-storage">nicht kompatibel</a> mit der <code>multer</code>-Version <code>1.4.5.-lts.1</code>. Wir müssen deshalb in der <code>package.json</code> die Version für <code>multer</code> auf <code>1.4.4.</code> setzen:</p>
<p>Die <code>package.json</code> sollte nun ungefähr so aussehen:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">package.json</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Backend REST-API&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;main&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;server.js&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;scripts&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;watch&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;nodemon ./server.js&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;test&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s2">&quot;keywords&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;rest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;api&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;backend&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;mongodb&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="s2">&quot;author&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;J. Freiheit&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;license&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ISC&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;dependencies&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;cors&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;^2.8.5&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;dotenv&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;^16.0.3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;express&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;^4.18.2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;mongodb&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;^5.5.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;multer&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;^1.4.4&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;multer-gridfs-storage&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;^5.0.2&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s2">&quot;devDependencies&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;nodemon&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;^2.0.22&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>Zunächst erstellen wir zwei weitere Routen <code>/download</code> und <code>/upload</code> in der <code>server.js</code>. </p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">server.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">postRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/post.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">uploadRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/upload.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">downloadRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/download.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">PORT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="c1">// enable cors for all requests</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">postRoutes</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">uploadRoutes</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/download&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">downloadRoutes</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`server running on http://localhost:</span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>Wir benötigen also sowohl eine <code>routes/upload.routes.js</code> als auch eine <code>routes/download.routes.js</code>. Beachten Sie, dass zum Compilieren des Projektes in den beiden Skripten mindestens</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">routes/upload.routes.js</label><label for="__tabbed_3_2">routes/download.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">router</span><span class="p">;</span>
</code></pre></div>
</div>
</div>
</div>
<p>enthalten sein muss. Wir kümmern uns nun zunächst darum, Bilder in die MongoDB <em>hochzuladen</em>. </p>
<h3 id="upload-von-bildern">Upload von Bildern<a class="headerlink" href="#upload-von-bildern" title="Permanent link">&para;</a></h3>
<p>Für den Upload der Bilder erstellen wir zunächst einen Ordner <code>middleware</code> und darin eine Datei <code>upload.js</code>. In dieser Datei wird unter Verwendung von <code>Multer</code> ein <code>GridFsStorage</code> eingerichtet. Die zu verwendende <em>Collection</em> benennen wir hier <code>posts</code> (siehe <code>bucketName</code>). Die Datenbank heißt <code>image</code> (siehe <code>dbName</code>). Sie können diese Namen frei wählen. Beachten Sie dann aber im Folgenden überall die Verwendung von <code>posts</code> (in der MongoDB entstehen die Collections <code>posts.files</code> und <code>posts.chunks</code> - siehe z.B. <a href="https://medium.com/@kavitanambissan/uploading-and-retrieving-a-file-from-gridfs-using-multer-958dfc9255e8">hier</a> oder <a href="https://www.topcoder.com/thrive/articles/storing-large-files-in-mongodb-using-gridfs">hier</a>).</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">middleware/upload.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">multer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;multer&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">GridFsStorage</span>
<span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;multer-gridfs-storage&quot;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>


<span class="kd">const</span><span class="w"> </span><span class="nx">credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PATH_TO_PEM</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">GridFsStorage</span><span class="p">({</span>
<span class="w">    </span><span class="c1">//db: connection,</span>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">sslKey</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span><span class="w">        </span><span class="c1">// nur falls ein Zertifikat zur Autorisierung</span>
<span class="w">    </span><span class="nx">sslCert</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span><span class="w">       </span><span class="c1">// für MongoDB Atlas verwendet wird</span>
<span class="w">    </span><span class="nx">dbName</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;htwinsta&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;image/jpg&quot;</span><span class="p">];</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">mimetype</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;file.mimetype === -1&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">-jf-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">bucketName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;posts&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">-jf-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">multer</span><span class="p">({</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="p">});</span>
</code></pre></div></td></tr></table></div>
<p>Beachten Sie, dass wir beim Upload der Bilder für diese Bilder Dateinamen mithilfe von <code>${Date.now()}-jf-${file.originalname}</code> erstellen bzw. festlegen. Damit diese Dateinamen eindeutig sind, wird mithilfe von <code>Date.now()</code> der aktuelle Zeitstempel verwendet. Der String <code>-jf-</code> in der Mitte kann natürlich auch durch Ihre Initialen ersetzt (oder weggelassen) werden. Außerdem wird auch noch der originale Dateiname verwendet. Insgesamt sollte sichergestellt werden, dass die Dateinamen eindeutig sind (deshalb auch <code>Date.now()</code>). </p>
<p>In Zeile <code>18</code> werden die Dateitypen festgelegt, die akzeptiert werden, hier <code>png</code> und <code>jpeg</code>. Diese Liste kann erweitert oder eingegrenzt werden.</p>
<p>Diese <em>Middleware</em> nutzen wir nun für den <code>POST</code>-Request des Bildes (siehe folgend Zeile <code>5</code> <code>upload.single('file')</code>) und implementieren die <code>routes/upload.routes.js</code> wie folgt:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">routes/upload.route.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">upload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middleware/upload&#39;</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">upload</span><span class="p">.</span><span class="nx">single</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
<span class="w">            </span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;no file selected&quot;</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;req.file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">imgUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`http://localhost:3000/download/</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">filename</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span>
<span class="w">            </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">imgUrl</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">router</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>In Zeile <code>5</code> wird die <em>multer-Middleware</em> mit <code>update.single('file')</code> aufgerufen. Deren Funktionalität haben wir in der <code>middleware/upload.js</code> überschrieben und genauer spezifiziert. Neben der Funktion <code>.single(fieldname)</code> stehen auch die Funktionen <code>.array(fieldname[, maxCount])</code> und <code>.fields(field)</code> zur Verfügung, um gleichzeitig mehrere Dateien hochzuladen (siehe <a href="https://www.npmjs.com/package/multer">multer</a>). </p>
<p>Als <em>Response</em> wird die URL zurückgegeben, unter der das Bild heruntergeladen werden kann (<code>http://localhost:3000/download/${req.file.filename}</code>). Beachten Sie, dass die Backend-URL und auch der Port hier hart kodiert sind. Das sollte besser in die <code>.env</code>-Datei ausgelagert werden. </p>
<h3 id="upload-mithilfe-von-postman">Upload mithilfe von Postman<a class="headerlink" href="#upload-mithilfe-von-postman" title="Permanent link">&para;</a></h3>
<p>Das Hochladen der Bilder kann nun getestet werden. Starten Sie das Backend. Öffnen Sie Postman und geben Sie als URL <code>http://localhost:3000/upload</code> ein und wählen als Anfragemethode <code>POST</code>. Klicken Sie auf <code>Body</code> und markieren dann <code>form-data</code>:</p>
<p><img alt="upload" src="../files/244_file.png" /></p>
<p>Geben Sie unter <code>KEY</code> den Schlüssel <code>file</code> ein (das wird manchmal vergessen und dann bekommen Sie einen <code>multer</code>-Fehler <code>unexpected field</code>!) und wählen Sie aus dem Dropdown-Menü <code>File</code>. Unter <code>VALUE</code> erscheint der Button <code>Select Files</code>. Klicken Sie darauf und wählen ein <code>png</code>- oder ein <code>jpeg</code>-Bild (kann auch <code>.jpg</code> sein) aus, das Sie hochladen wollen. Klicken Sie dann auf <code>Send</code>. Es erscheint:</p>
<p><img alt="upload" src="../files/245_file.png" /></p>
<p>Ich habe in diesem Beispiel die Datei <code>fiw.jpg</code> hochgeladen. </p>
<p>Wenn Sie sich die MongoDB anschauen (in Compass), dann finden Sie darin die beiden Collections <code>posts.files</code> und <code>posts.chunks</code>. In <code>posts.files</code> sind die Metadaten des hochgeladenen Bildes zu finden, z.B. </p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;646062e135cc14afbf5fd29b&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">86584</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">261120</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-05-14T04:26:10.472Z&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1684038369483-jf-fiw.jpg&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;image/jpeg&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Die dazugehörige <code>_id</code> finden Sie auch in <code>posts.chunks</code> (können Sie sich in der <code>mongosh</code> mit <code>db.posts.chunks.find({ _id: "646062e135cc14afbf5fd29b" })</code> anschauen). Darin ist das Bild im Binary-Format gespeichert. </p>
<h3 id="download-von-bildern">Download von Bildern<a class="headerlink" href="#download-von-bildern" title="Permanent link">&para;</a></h3>
<p>Für den Download der gespeicherten Bilder gehen wir ähnlich vor, wie beim Upload, benötigen dafür aber nicht mehr die <em>multer-Middleware</em>, dafür aber <a href="https://www.mongodb.com/docs/drivers/node/current/fundamentals/gridfs/">GridFS Bucket</a> aus dem <a href="https://www.mongodb.com/docs/drivers/node/current/">MongoDB-Node</a>-Paket. Wir implementieren <code>routes/download.routes.js</code> mit folgendem Inhalt:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:1"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">routes/download.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongodb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">database</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../configure/db&#39;</span><span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">mongodb</span><span class="p">.</span><span class="nx">GridFSBucket</span><span class="p">(</span><span class="nx">database</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">bucketName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;posts&#39;</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:filename&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">filename</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">downloadStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bucket</span><span class="p">.</span><span class="nx">openDownloadStreamByName</span><span class="p">(</span><span class="nx">filename</span><span class="p">);</span>
<span class="w">        </span><span class="nx">downloadStream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="w">        </span><span class="nx">downloadStream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; does not exist&quot;</span><span class="w"> </span><span class="p">}));</span>
<span class="w">        </span><span class="nx">downloadStream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;not found&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">router</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p><a href="https://mongodb.github.io/node-mongodb-native/3.2/api/GridFSBucket.html">GridFSBucket</a> ist eine Klasse aus der <a href="https://mongodb.github.io/node-mongodb-native/3.2/api/index.html">Node.js-MongoDB-API</a>. Diese hätten wir auch schon für das Upload verwenden können (siehe z.B. <a href="https://edupeeth.com/all-courses/nodejs/mongodb-gridfs-bucket">hier</a>). </p>
<p>Mit der <code>openDownloadStream()</code>-Funktion der <code>GridFSBucket()</code>-Klasse öffnen wir den Download-Stream des Bildes und geben ihn (genauer gesagt, die Daten <code>data</code> des Streams) als <em>response</em> <code>res</code> zurück. </p>
<h3 id="download-mithilfe-von-postman">Download mithilfe von Postman<a class="headerlink" href="#download-mithilfe-von-postman" title="Permanent link">&para;</a></h3>
<p>Der Test des <code>GET http://localhost:3000/download/:filename</code>-Endpunktes ist einfach. Dazu verwenden wir einfach die URL, die durch den Upload als <em>Response</em>  zurückgegeben wurde (im obigen Beispiel also <code>"http://localhost:3000/download/1684038369483-jf-fiw.jpg"</code>):</p>
<p>Geben Sie in Postman also Ihre URL ein, wählen <code>GET</code> und klicken <code>Send</code>. Es erscheint das Bild:</p>
<p><img alt="upload" src="../files/246_file.png" /></p>
<p>Da es sich um die GET-Methode handelt, können Sie die URL <code>http://localhost:3000/download/1684038369483-jf-fiw.jpg</code> natürlich auch in den Browser eingeben und das Bild erscheint. </p>
<h3 id="delete-von-bildern">Delete von Bildern<a class="headerlink" href="#delete-von-bildern" title="Permanent link">&para;</a></h3>
<p>Das Löschen der Bilder ist ganz ähnlich zum Download. Wir kommen hier allerdings ohne einen Stream aus und benötigen nur die <code>delete()</code>-Funktion von <code>GridFSBucket</code>. Außerdem suchen wir hier nicht nach dem Dateinamen, sondern nach der <code>id</code>. Erstellen Sie die Datei <code>routes/delete.route.js</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:1"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">routes/delete.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongodb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">database</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../configure/db&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w">  </span><span class="nx">ObjectId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">ObjectId</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">mongodb</span><span class="p">.</span><span class="nx">GridFSBucket</span><span class="p">(</span><span class="nx">database</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">bucketName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;posts&#39;</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">bucket</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="nx">id</span><span class="p">));</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;deleted&quot;</span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;id &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; does not exist&quot;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">router</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>und binden diese in die <code>server.js</code> ein:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:1"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">server.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">postRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/post.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">uploadRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/upload.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">downloadRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/download.routes&#39;</span><span class="p">);</span>
<span class="hll"><span class="kd">const</span><span class="w"> </span><span class="nx">deleteRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/delete.routes&#39;</span><span class="p">);</span>
</span><span class="kd">const</span><span class="w"> </span><span class="nx">cors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">PORT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="c1">// enable cors for all requests</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">postRoutes</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">uploadRoutes</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/download&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">downloadRoutes</span><span class="p">);</span>
<span class="hll"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/delete&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">deleteRoutes</span><span class="p">);</span>
</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`server running on http://localhost:</span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div></td></tr></table></div>
<h3 id="delete-mithilfe-von-postman">Delete mithilfe von Postman<a class="headerlink" href="#delete-mithilfe-von-postman" title="Permanent link">&para;</a></h3>
<p>Zum Testen verwenden Sie die <code>id</code> und wählen als Anfragemethode <code>DELETE</code>. Senden Sie ruhig zwei Mal ab, beim ersten Mal wird die Datei gelöscht (aus <code>.files</code> und auch aus <code>.chunks</code>) und beim zweiten Mal sollte eine Fehlermessage erfolgen. </p>
<h2 id="zusammenfuhren-der-funktionalitaten">Zusammenführen der Funktionalitäten<a class="headerlink" href="#zusammenfuhren-der-funktionalitaten" title="Permanent link">&para;</a></h2>
<p>Wir haben nun recht viele Routen und Endpunkte in unserem Backend. Wir wollen aber gerne, dass es nur die fünf genannten Endpunkte gibt:</p>
<table>
<thead>
<tr>
<th> Methode</th>
<th> URL</th>
<th> Bedeutung</th>
</tr>
</thead>
<tbody>
<tr>
<td> GET</td>
<td> /posts</td>
<td> hole alle Datensätze</td>
</tr>
<tr>
<td> GET</td>
<td> /posts/11</td>
<td>hole den Datensatz mit der id=11</td>
</tr>
<tr>
<td> POST</td>
<td> /posts</td>
<td> füge einen neuen Datensatz hinzu</td>
</tr>
<tr>
<td> PUT</td>
<td> /posts/11</td>
<td> ändere den Datensatz mit der id=11</td>
</tr>
<tr>
<td> DELETE</td>
<td> /posts/11</td>
<td> lösche den Datensatz mit der id=11</td>
</tr>
</tbody>
</table>
<p>Das bedeutet, wir binden den Upload und Download von Bildern nun in unsere <code>posts</code>-Routen ein. Die Funktionen werden dabei "etwas" umfangreicher. </p>
<h3 id="zum-verstandnis">Zum Verständnis<a class="headerlink" href="#zum-verstandnis" title="Permanent link">&para;</a></h3>
<p>Wir verwenden <a href="https://www.npmjs.com/package/multer">Multer</a> und <a href="https://www.npmjs.com/package/multer-gridfs-storage">GridFs Storage</a>. Multer ist eine <em>Middleware</em> für Node.js, um Daten im <code>multipart/form-data</code>-Format zu verwalten. Die grundsätzliche Idee ist, dass im <em>Request</em> nicht nur ein <code>body</code>, sondern auch eine <code>file</code>-Eigenschaft enthalten ist (neben dem <code>header</code>). Multer verwendet einen <code>storage</code>, um Bilder (oder andere Dateien) zu speichern. Einen solchen <code>storage</code> bietet <code>GridFs Storage</code>. Dieser kann sogar Dateien größer als 16 MB speichern und die Idee dabei ist, dass die Datei in zwei Collections gespeichert wird, in der <code>files</code>-Collection, welche die (Meta-)Informationen der Datei speichert und der <code>chunks</code>-Collection, die die eigentliche Datei (als Binärdaten) speichert. Eine Datei kann dabei in mehrere <code>chunks</code> unterteilt werden. Die folgende Abbildung zeigt das Prinzip von <code>GridFS</code>:</p>
<p><img alt="upload" src="../files/251_file.png" /></p>
<p>Für unser Datenmodell sieht die Aufteilung der Daten somit wie folgt aus:</p>
<ul>
<li>
<p>in der <code>posts</code>-Collection speichern wir</p>
<ul>
<li>die <code>_id</code> des Posts,</li>
<li>den <code>title</code> eines Posts,</li>
<li>die <code>location</code> und </li>
<li>die <code>image_id</code>. Die <code>image_id</code> enthält den Dateinamen <code>filename</code> des Bildes.</li>
</ul>
</li>
<li>
<p>in der <code>posts.files</code>-Collection speichern wir (GridFs)</p>
<ul>
<li>die <code>_id</code> der Datei,</li>
<li>die <code>length</code> der Datei,</li>
<li>die <code>chunkSize</code>, </li>
<li>das <code>uploadDate</code>, </li>
<li>den <code>filename</code> (siehe in <code>posts</code> die <code>image_id</code>) und </li>
<li>den <code>contenType</code> (z.B. <code>image/jpeg</code>)</li>
</ul>
</li>
<li>
<p>in der <code>posts.chunks</code>-Collection speichern wir (GridFs)</p>
<ul>
<li>die <code>_id</code> des Chunks,</li>
<li>die <code>files_id</code> (diese entspricht der <code>_id</code> der Datei in der <code>posts.files</code>-Collection),</li>
<li>ein <code>n</code> (fortlaufende Nummerierung der Chunks einer Datei beginnend mit <code>0</code>),</li>
<li>die <code>data</code> der Datei (in diesem Chunk)</li>
</ul>
</li>
</ul>
<p>Chunks kann es zu einer Datei mehrere geben. Alle <code>data</code> aller Chunks einer Datei bilden zusammen die Datei als Binär- (bzw. base64-) Daten. Die folgende Abbildung zeigt unser Datenmodell in der Datenbank <code>posts</code>:</p>
<p><img alt="upload" src="../files/251_file.png" /></p>
<p>Um z.B. einen Datensatz (einen Post) anzulegen, speichern wir also die zugehörigen Daten in der <code>posts</code>-Collection (inkl. dem <code>filename</code> der Datei), speichern die Meta-Informationen der Datei in der <code>posts.files</code>-Collection und die zugehörigen Binärdaten der Datei in <code>posts.chunks</code>. </p>
<h3 id="post-kompletter-datensatz">POST - kompletter Datensatz<a class="headerlink" href="#post-kompletter-datensatz" title="Permanent link">&para;</a></h3>
<p>Die <code>POST</code>-Funktion für einen Datensatz ist nicht viel umfangreicher als zuvor:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">aus routes/post.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// POST one new post</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">upload</span><span class="p">.</span><span class="nx">single</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
<span class="w">            </span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;no file selected&quot;</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">newPost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
<span class="w">                </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
<span class="w">                </span><span class="nx">image_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">filename</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">collection</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span><span class="nx">newPost</span><span class="p">);</span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">);</span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
<span class="w">                </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Post not created&quot;</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}}</span>
<span class="p">});</span>
</code></pre></div></td></tr></table></div>
<p>Wichtig ist, dass <code>post.routes.js</code> nun auch die <code>upload.js</code> einbindet:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:1"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">aus routes/post.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">upload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middleware/upload&#39;</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
Achten Sie darauf, dass Sie in <code>upload.js</code> die korrekte Datenbank verwenden (siehe <code>dbName</code>)!</p>
<p>Beachten Sie, dass die Daten nun nicht mehr als JSON übergeben werden, sondern als <code>form-data</code>. Der Test mithilfe von Postman sieht deshalb nun so aus:</p>
<p><img alt="posts" src="../files/247_file.png" /> </p>
<p>Als Response bekommen Sie aber wieder ein JSON zurück, z.B.:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;acknowledged&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;insertedId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;627a0ff2305433d805b6b435&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Das Bild ist nun in der Collection <code>posts</code> einerseits in <code>posts.files</code> mit den Daten</p>
<p><img alt="posts" src="../files/248_file.png" /> </p>
<p>und in <code>posts.chunks</code> mit den Daten</p>
<p><img alt="posts" src="../files/249_file.png" /> </p>
<p>gespeichert. Beachten Sie, dass das Bild so klein ist, dass es in nur einem <code>chunk</code> gespeichert werden kann. Größere Dateien werden in mehrer <code>chunks</code> aufgeteilt. Alle diese <code>chunks</code>, die zu einem Bild gehören, haben dann dieselbe <code>files_id</code> (aber fortlaufende <code>_id</code>s).</p>
<p>In der <code>posts</code>-Collection sieht der Datensatz dann wie folgt aus:</p>
<p><img alt="posts" src="../files/250_file.png" /> </p>
<h3 id="get-ein-kompletter-datensatz">GET - ein kompletter Datensatz<a class="headerlink" href="#get-ein-kompletter-datensatz" title="Permanent link">&para;</a></h3>
<p>Jetzt den kompletten Datensatz mit einer bestimmten <code>_id</code> zu laden, ist etwas aufwendiger:</p>
<ol>
<li>Wir laden zunächst aus der <code>posts</code>-Collection den Datensatz mit der <code>_id</code>. </li>
<li>Aus diesem Datensatz lesen wir die <code>image_id</code> aus. Das ist der <code>filename</code> mit dem wir in der <code>posts.files</code>-Collection suchen. </li>
<li>Aus der <code>posts.files</code>-Collection lesen wir den Datensatz mit dem <code>filename</code> aus und identifizieren dessen <code>_id</code>. </li>
<li>Nach dieser <code>_id</code> suchen wir unter <code>files_id</code> in der <code>posts.chunks</code>-Collection und lesen alle zugehörigen <code>chunks</code> aus. </li>
</ol>
<p>Dazu schreiben wir uns zunächst eine Funktion <code>getOnePost(id)</code>, die ein <code>Promise</code> zurückgibt.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:1"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">aus routes/posts.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PATH_TO_PEM</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">sslKey</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sslCert</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span>
<span class="w">    </span><span class="nx">dbName</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;htwinsta&quot;</span><span class="w"> </span><span class="p">});</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">getOnePost</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connection</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.files&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connection</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.chunks&#39;</span><span class="p">);</span>

<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursorFiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="nx">fileName</span><span class="p">});</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">allFiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">cursorFiles</span><span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursorChunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">files_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">allFiles</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">});</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">sortedChunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cursorChunks</span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="nx">n</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">});</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">chunk</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">sortedChunks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">fileData</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">base64file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;data:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">allFiles</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">contentType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;;base64,&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fileData</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">getPost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Post</span><span class="p">({</span>
<span class="w">                </span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;location&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">post</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="s2">&quot;image_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">base64file</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="c1">//console.log(&#39;getPost&#39;, getPost)</span>
<span class="w">            </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">getPost</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Post does not exist!&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Die Konsolenausgaben können natürlich auch alle entfernt werden, aber es lohnt sich vielleicht auch zu sehen, was an den einzelnen Stellen passiert. In Zeile <code>37</code> erfolgt der Zugriff auf die <code>posts</code>-Collection und es wird der Datensatz mit der <code>_id</code> ermittelt, welche als Parameter der URL übergeben wurde. Aus dem Ergebnis <code>post</code> wird dann der Dateiname des Bildes in Zeile <code>37</code> mithilfe von <code>post.image_id</code> ermittelt. </p>
<p>In der <code>post.files</code>-Collection wird in Zeile <code>42</code> nach dem Datensatz mit dem entsprechenden <code>filename</code> gesucht. Die <code>_id</code> dieses Datensatzes ist der Wert von <code>files_id</code> in der Collection <code>posts.chunks</code>. Nach all diesen Einträgen wird in Zeile <code>44</code> gesucht. Aus allen <code>chunks</code> wird dann der <code>base64</code>-String erzeugt und dem <code>Post</code>-Objekt übergeben, welches als <code>resolve</code> der <code>Promise</code> zurückgeschickt wird. </p>
<p>Diese Funktion können wir nun für unseren <code>get('/:id')</code>-Endpunkt verwenden. Die Funktion sieht dann wie folgt aus:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="12:1"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="__tabbed_12_1">aus routes/posts.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// GET one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">getOnePost</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">post</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">post</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
<span class="w">            </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Post does not exist!&quot;</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">});</span>
</code></pre></div></td></tr></table></div>
<p>Wir übergeben der <code>getOnePost()</code>-Funktion die als Parameter übergebene <code>id</code> und senden den <code>resolve</code>-Wert der <code>Promise</code> als Response zurück. </p>
<h3 id="get-alle-datensatze">GET - alle Datensätze<a class="headerlink" href="#get-alle-datensatze" title="Permanent link">&para;</a></h3>
<p>Der Ansatz, um alle Datensätze aus der MongoDB zu lesen, ist der gleiche, wie für einen Datensatz. Wir ermitteln sukzessive die <code>_id</code> alle Datensätze in der <code>posts</code>-Collection. Dazu schreiben wir uns eine Funktion <code>getAllPosts()</code>. In dieser laden wir zunächst alle <code>posts</code> und rufen dann für jeden einzelnen die <code>getOnePost(id</code>-Funktion auf:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="13:1"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="__tabbed_13_1">aus routes/posts.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">getAllPosts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sendAllPosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">allPosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Post</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">post</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">allPosts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">post</span><span class="p">)</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">onePost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getOnePost</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
<span class="w">                </span><span class="nx">sendAllPosts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">onePost</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;sendAllPosts&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sendAllPosts</span><span class="p">)</span>
<span class="w">            </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">sendAllPosts</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Posts do not exist!&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Die Verwendung dieser Funktion ist wie oben:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="14:1"><input checked="checked" id="__tabbed_14_1" name="__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="__tabbed_14_1">aus routes/posts.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// GET all posts</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nx">getAllPosts</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">posts</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">posts</span><span class="p">);</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
<span class="w">            </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Post do not exist!&quot;</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">});</span>
</code></pre></div></td></tr></table></div>
<h3 id="delete-einen-datensatz">DELETE - einen Datensatz<a class="headerlink" href="#delete-einen-datensatz" title="Permanent link">&para;</a></h3>
<p>Wird ein Post gelöscht, müssen wir auch dafür sorgen, dass das zugehörige Bild aus der <code>posts.files</code> und der <code>posts.chunks</code> gelöscht wird. Das Löschen ist also dreistufig:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="15:1"><input checked="checked" id="__tabbed_15_1" name="__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="__tabbed_15_1">aus routes/posts.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// DELETE one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span><span class="p">;</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">Post</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="nx">fileName</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">docs</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">({</span><span class="nx">files_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">});</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="nx">fileName</span><span class="p">});</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">204</span><span class="p">).</span><span class="nx">send</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Post does not exist!&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div></td></tr></table></div>
<h3 id="zusammenfassung-code-des-backends">Zusammenfassung - Code des Backends<a class="headerlink" href="#zusammenfassung-code-des-backends" title="Permanent link">&para;</a></h3>
<p>Hier nochmal alle wichtigen Dateien unseres Backends:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="16:1"><input checked="checked" id="__tabbed_16_1" name="__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="__tabbed_16_1">server.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">postsRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/posts.routes&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">uploadRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/upload.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">downloadRoute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/download.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">deleteRoute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/delete.routes&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PATH_TO_PEM</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">()</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">PORT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">postsRoutes</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">uploadRoutes</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/download&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">downloadRoute</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/delete&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">deleteRoute</span><span class="p">);</span>

<span class="c1">// connect to mongoDB</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">sslKey</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sslCert</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span>
<span class="w">    </span><span class="nx">dbName</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE</span><span class="w"> </span><span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;connected to DB&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`server running on http://localhost:</span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">})</span>
</code></pre></div></td></tr></table></div>
<div class="tabbed-set tabbed-alternate" data-tabs="17:1"><input checked="checked" id="__tabbed_17_1" name="__tabbed_17" type="radio" /><div class="tabbed-labels"><label for="__tabbed_17_1">middleware/upload.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">multer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;multer&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">GridFsStorage</span>
<span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;multer-gridfs-storage&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>


<span class="kd">const</span><span class="w"> </span><span class="nx">credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PATH_TO_PEM</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">GridFsStorage</span><span class="p">({</span>
<span class="w">    </span><span class="c1">//db: connection,</span>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">sslKey</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span><span class="w">        </span><span class="c1">// nur falls ein Zertifikat zur Autorisierung</span>
<span class="w">    </span><span class="nx">sslCert</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span><span class="w">       </span><span class="c1">// für MongoDB Atlas verwendet wird</span>
<span class="w">    </span><span class="nx">dbName</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;htwinsta&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">];</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">mimetype</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;file.mimetype === -1&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">-jf-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">bucketName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;posts&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">-jf-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">multer</span><span class="p">({</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="p">});</span>
</code></pre></div></td></tr></table></div>
<div class="tabbed-set tabbed-alternate" data-tabs="18:1"><input checked="checked" id="__tabbed_18_1" name="__tabbed_18" type="radio" /><div class="tabbed-labels"><label for="__tabbed_18_1">routes/posts.routes.js</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">()</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/posts&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">upload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middleware/upload&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="cm">/* ----------------- POST ---------------------------- */</span>

<span class="c1">// POST one post</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">upload</span><span class="p">.</span><span class="nx">single</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newPost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Post</span><span class="p">({</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
<span class="w">        </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
<span class="w">        </span><span class="nx">image_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">filename</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">newPost</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newPost</span><span class="p">);</span>
<span class="p">});</span>

<span class="cm">/* ----------------- GET ---------------------------- */</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PATH_TO_PEM</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_CONNECTION</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">sslKey</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sslCert</span><span class="o">:</span><span class="w"> </span><span class="nx">credentials</span><span class="p">,</span>
<span class="w">    </span><span class="nx">dbName</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;htwinsta&quot;</span><span class="w"> </span><span class="p">});</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">getOnePost</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connection</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.files&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connection</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts.chunks&#39;</span><span class="p">);</span>

<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursorFiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="nx">fileName</span><span class="p">});</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">allFiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">cursorFiles</span><span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursorChunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">files_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">allFiles</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">});</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">sortedChunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cursorChunks</span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="nx">n</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">});</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">chunk</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">sortedChunks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">fileData</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">base64file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;data:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">allFiles</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">contentType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;;base64,&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fileData</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">getPost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Post</span><span class="p">({</span>
<span class="w">                </span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;location&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">post</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="s2">&quot;image_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">base64file</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="c1">//console.log(&#39;getPost&#39;, getPost)</span>
<span class="w">            </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">getPost</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Post does not exist!&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">getAllPosts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sendAllPosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">allPosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Post</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">post</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">allPosts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">post</span><span class="p">)</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">onePost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getOnePost</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
<span class="w">                </span><span class="nx">sendAllPosts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">onePost</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;sendAllPosts&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sendAllPosts</span><span class="p">)</span>
<span class="w">            </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">sendAllPosts</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Posts do not exist!&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// GET one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">getOnePost</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">post</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">post</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
<span class="w">            </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Post does not exist!&quot;</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">});</span>

<span class="c1">// GET all posts</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">getAllPosts</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">posts</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">posts</span><span class="p">);</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
<span class="w">            </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Post do not exist!&quot;</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">});</span>

<span class="cm">/* ----------------- DELETE ---------------------------- */</span>

<span class="c1">// DELETE one post via id</span>
<span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">post</span><span class="p">.</span><span class="nx">image_id</span><span class="p">;</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">Post</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="nx">fileName</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span><span class="w"> </span><span class="k">async</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">docs</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">({</span><span class="nx">files_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">});</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="nx">fileName</span><span class="p">});</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">204</span><span class="p">).</span><span class="nx">send</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Post does not exist!&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">router</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<div class="tabbed-set tabbed-alternate" data-tabs="19:1"><input checked="checked" id="__tabbed_19_1" name="__tabbed_19" type="radio" /><div class="tabbed-labels"><label for="__tabbed_19_1">.env</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><pre><span></span><code>DB_CONNECTION = mongodb+srv://ikt-pwa.0elr1ih.mongodb.net/?authSource=%24external&amp;authMechanism=MONGODB-X509&amp;retryWrites=true&amp;w=majority
DATABASE = htwinsta
PATH_TO_PEM = assets/X509-cert-3298914405631471913.pem
PORT = 3000
</code></pre></div>
<h3 id="zusammenfassung-die-mongodb-posts">Zusammenfassung - die MongoDB <code>posts</code><a class="headerlink" href="#zusammenfassung-die-mongodb-posts" title="Permanent link">&para;</a></h3>
<p>Hier einige Datensätze für die Datenbank <code>posts</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="20:1"><input checked="checked" id="__tabbed_20_1" name="__tabbed_20" type="radio" /><div class="tabbed-labels"><label for="__tabbed_20_1">Collection posts</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278e79c6664ce70884dd0b0&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;WH Eingang&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652090780364-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a0ff2305433d805b6b437&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;HTW Gebäude C&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652166642127-jf-htwbild5.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7cad8ae16b1ba5f62f76&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Mensastrand&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof Mensa&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194477890-jf-htwbild1.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7cdf8ae16b1ba5f62f80&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Wiese Campus WH&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof Gebäude C&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194527176-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d0b8ae16b1ba5f62f84&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Berühmt wegen FIW&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Campus Wilhelminenhof Gebäude C&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194571822-jf-htwbild3.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d398ae16b1ba5f62f8b&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Haupttor HTW&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;Wilhelminenhofstraße HTW&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194617191-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d608ae16b1ba5f62f8f&quot;</span><span class="p">},</span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Gebäude C&quot;</span><span class="p">,</span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="s2">&quot;HTW Berlin&quot;</span><span class="p">,</span><span class="nt">&quot;image_id&quot;</span><span class="p">:</span><span class="s2">&quot;1652194656102-jf-htwbild5.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;__v&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="tabbed-set tabbed-alternate" data-tabs="21:1"><input checked="checked" id="__tabbed_21_1" name="__tabbed_21" type="radio" /><div class="tabbed-labels"><label for="__tabbed_21_1">Collection posts.files</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278d47e96a41858d66f1621&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">984341</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T08:44:46.239Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652085886102-jf-htwbild1.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278d5f902370f2c675993e9&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1601800</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T08:51:05.478Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652086265414-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278db738d2b5bc5968f453e&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1601800</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T09:14:27.957Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652087667872-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278db918d2b5bc5968f4546&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1601800</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T09:14:57.113Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652087697071-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278dd057c648b9e8e3bbb74&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">117492</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T09:21:09.873Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652088069823-jf-htwbild3.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278e74458477bf1223fa286&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1038579</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T10:04:53.07Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652090692995-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;6278e79c6664ce70884dd0ab&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1038579</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-09T10:06:20.437Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652090780364-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a0ff2305433d805b6b435&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">25449</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T07:10:42.191Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652166642127-jf-htwbild5.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7cad8ae16b1ba5f62f71&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">984341</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:54:37.954Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194477890-jf-htwbild1.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7cdf8ae16b1ba5f62f78&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1601800</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:55:27.23Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194527176-jf-htwbild2.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d0b8ae16b1ba5f62f82&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">117492</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:56:11.84Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194571822-jf-htwbild3.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d398ae16b1ba5f62f86&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">1038579</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:56:57.214Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194617191-jf-htwbild4.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;627a7d608ae16b1ba5f62f8d&quot;</span><span class="p">},</span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="mi">25449</span><span class="p">,</span><span class="nt">&quot;chunkSize&quot;</span><span class="p">:</span><span class="mi">261120</span><span class="p">,</span><span class="nt">&quot;uploadDate&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2022-05-10T14:57:36.11Z&quot;</span><span class="p">},</span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="s2">&quot;1652194656102-jf-htwbild5.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Die Collection <code>posts.chunks</code> ist sehr groß, deshalb <a href="../files/posts_chunks.json">hier zum Download</a>.</p>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Fußzeile" >
        
          
          <a href="../indexeddb/" class="md-footer__link md-footer__link--prev" aria-label="Zurück: IndexedDB" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Zurück
              </span>
              <div class="md-ellipsis">
                IndexedDB
              </div>
            </div>
          </a>
        
        
          
          <a href="../kamera/" class="md-footer__link md-footer__link--next" aria-label="Weiter: Kamera" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Weiter
              </span>
              <div class="md-ellipsis">
                Kamera
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 Jörn Freiheit
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["instant", "tabs", "navigation.footer", "navigation.instant", "content.action.edit", "content.action.view", "content.code.copy", "content.code.select", "content.tabs.link"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "In Zwischenablage kopiert", "clipboard.copy": "In Zwischenablage kopieren", "search.result.more.one": "1 weiteres Suchergebnis auf dieser Seite", "search.result.more.other": "# weitere Suchergebnisse auf dieser Seite", "search.result.none": "Keine Suchergebnisse", "search.result.one": "1 Suchergebnis", "search.result.other": "# Suchergebnisse", "search.result.placeholder": "Suchbegriff eingeben", "search.result.term.missing": "Es fehlt", "select.version": "Version ausw\u00e4hlen"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51198bba.min.js"></script>
      
    
  </body>
</html>